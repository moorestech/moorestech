# クラフトツリー／目標表示　実装引き継ぎ情報

## プロジェクト概要

「クラフトツリー」と「目標表示（HUD）」機能は、REI系のレシピ閲覧システムをmoorestechゲーム向けに拡張した機能です。

1. **クラフトツリー機能** - プレイヤーが作成したいアイテムを選択し、必要な素材をツリー形式で表示
2. **目標表示HUD** - 左上に直近で取得すべきアイテムリストを表示

## 設計方針のポイント

* **データモデルはサーバー側に定義**：クライアントはサーバーのモデルを参照（クライアント→サーバーの依存関係）
* **クライアント主導の編集**：UXの即応性を確保するため、クライアント側で編集操作を先行し、サーバーに同期
* **サーバー側での状態管理**：完了判定やインベントリ反映はサーバー側で実施
* **イベントベースの更新通知**：サーバー側での状態変化はイベントでクライアントに通知

## 責任分担

### サーバー側（Game.CraftTree名前空間）
* 基本データモデルの定義（CraftTree、CraftTreeNode等）
* クラフトツリーデータの永続化
* インベントリに基づくノード進捗・完了の判定
* 目標アイテムの算出

### クライアント側（Client.Game.InGame.CraftTree名前空間）
* ツリーの編集操作の処理
* UIの表示と操作（ツリー表示、レシピ選択、コンテキストメニュー）
* サーバーとの同期処理
* 目標HUDの表示

## 主要なクラスと役割

### データモデル（サーバー側）
* `CraftTreeNode` - ツリーの各ノードを表現
* `CraftTree` - ツリー全体を管理
* `RecipeData` - レシピ情報を保持
* `GoalItem` - 目標表示アイテムを表現

### マネージャー
* サーバー側 `CraftTreeManager` - 各プレイヤーのツリーデータを管理
* クライアント側 `ClientCraftTreeManager` - ローカルツリーの操作と表示の管理

### 通信
* `CraftTreeNetworkService` - クライアントとサーバー間の通信
* `CraftTreeSyncService` - 定期的な同期を管理
* `CraftTreeUpdateEventSender` - サーバーからクライアントへのイベント送信

## 実装順序の推奨

1. **サーバー側データモデル** - CraftTreeNode、CraftTree等の基本クラス
2. **サーバー側マネージャー** - CraftTreeManagerとサービスクラス
3. **通信プロトコル** - メッセージパックオブジェクトと送受信クラス
4. **クライアント側ネットワークサービス** - サーバーとの通信部分
5. **クライアント側マネージャー** - ClientCraftTreeManagerの実装
6. **UI要素** - ビューとコントローラーの実装
7. **同期サービス** - 定期的な同期とイベント処理の実装

## 特に注意が必要な点

1. **競合解決** - クライアント編集中にサーバーから更新が来た場合の競合処理
   * 基本的にサーバーからの更新を優先
   * ユーザー操作中の場合は通知や確認を表示することも検討

2. **ツリー操作の一貫性** - クライアントとサーバーで共通のツリー操作ロジックを確保
   * データモデルはサーバー側に定義しているが、操作方法に差異が出ないよう注意

3. **パフォーマンス** - 大きなツリーでの処理負荷に注意
   * 必要な部分だけ展開・処理する最適化を考慮
   * 通信量を抑えるため差分更新を活用

4. **エラー処理** - 通信エラーやデータ不整合への対応
   * タイムアウトやエラー時の再試行メカニズム
   * ユーザーへの適切な通知

## 次のステップ

1. サーバー側基本クラスの実装と単体テスト
2. クライアント側でのサーバークラス参照設定
3. クライアント・サーバー間の通信部分の実装
4. UIの実装（ユーザー体験を重視したインタラクション設計）
5. 統合テスト（特にエッジケースや競合ケース）

---

実装中に質問や不明点があれば再度相談してください。