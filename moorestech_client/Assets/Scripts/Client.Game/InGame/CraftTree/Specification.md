
# **moorestech ― クラフトツリー／目標表示　機能仕様書**

---

## 0. 目的

本仕様書は、**REI⼤系のレシピ閲覧を moorestech 向けに拡張**した
「クラフトツリー」と「目標表示（HUD）」を実装するための、ゲームプランナー向け設計ドキュメントである。
プログラム／UI 実装時の判断材料となるよう、操作フロー・データ状態・例外処理を網羅している。

---

## 1. 用語定義

| 用語          | 説明                        |
| ----------- | ------------------------- |
| **目的アイテム**  | プレイヤーが現在作成を目指す最終成果物。      |
| **ノード**     | クラフトツリー上の 1 アイテム。         |
| **レシピ**     | ノードを作成するためのクラフト手順 1 件を指す。 |
| **原材料アイテム** | レシピを持たない最下層ノード。           |
| **状態**      | *未展開／未完了／完了* の 3 段階。      |
| **目標アイテム群** | HUD に表示される「直近取得すべき」ノード集合。 |

---

## 2. 全体構成

```
┌ クラフトツリー（全画面・編集 UI）
│  ├ 目的アイテム設定
│  ├ レシピ選択・変更モーダル
│  ├ 進捗管理（完了判定）
│  └ コンテキストメニュー操作
└ 目標表示HUD（ゲーム画面左上固定）
   ├ 直近取得アイテム一覧
   └ 現在の材料でクラフト可能になる新アイテム一覧
```

---

## 3. クラフトツリー機能

### 3.1 基本フロー

1. **目的アイテムを設定**すると、画面中央にそのノードのみ表示。
2. プレイヤーがノードを*左クリック*

   * レシピが 1 件 → 直ちにノード展開。
   * 複数件 → モーダルでレシピ選択。
   * アンロック前レシピ → **非表示**（選択肢に出さない）。
3. 展開は **原材料アイテム** に到達するまで自由。
4. アイテムをゲーム内で取得すると、そのノードが\*\*完了（オレンジ）\*\*に変化。

   * 完了時点で目標表示が再計算される。

### 3.2 ノード状態遷移

| 状態  | 表示色  | 遷移条件           |
| --- | ---- | -------------- |
| 未展開 | 透明、非表示状態   | 目的アイテム設定直後等    |
| 未完了 | 灰色   | レシピ展開済・必要数未取得  |
| 完了  | オレンジ | 新規で獲得したアイテムが指定数に到達する |

> **備考**
>
> * 耐久値・返却物の概念無し。
> * 同名素材でも「結果が異なれば別ノード」として保持する（純粋な木構造）。

### 3.3 コンテキストメニュー（右クリック）

| ノード状態   | メニュー項目   | 挙動                       |
| ------- | -------- | ------------------------ |
| **完了**  | レシピ変更    | 選択モーダル → 下位ノード全リセット      |
|         | アイテムを非表示 | ノードと子孫ノードを折り畳み／HUD 対象外   |
|         | ここから上を未完了   | 親ノード以降を未完了状態に戻す          |
| **未完了** | レシピ変更    | 同上                       |
|         | アイテムを非表示 | 同上                       |
|         | 下位を完了にする | 自身と子ノードをすべて完了状態にする |

### 3.4 レシピ変更ルール

* 選択確定時に **確認モーダル** を表示

  > 「レシピを変更すると、このアイテムより下の進捗がリセットされます。よろしいですか？」
* **Yes** → 子孫ノードを全て非表示＋未完了へ戻す。
* 在庫アイテムは回収しない（進捗のみリセット）。

### 3.5 エラー & 例外

* **循環依存** 検出時：

  * ツリー生成を中断し、ダイアログ

    > 「レシピに循環構造が含まれているため展開できません」
* レシピ未アンロック：リスト非表示（ユーザーに気付かせない）。


## 4. 目標表示 HUD

### 4.1 更新トリガ

* クラフトツリー完了・未完了の状態が変わるたび自動再計算。

### 4.2 抽出アルゴリズム

1. ツリーを**深さ優先探索**。
2. 親が *完了* で、自身が *未完了* のノードを「直近取得すべき」と定義。
3. 抽出集合を **目標アイテム群** として HUD に一覧表示。

   * 同階層が多い場合は UI 仕様で表示上限 N 件。それ以外は「+X 他」。
4. 「いま収集済みアイテムでクラフト可能になるもの」は

   * 現在 *完了 or 未完了だが材料充足* のノードを上位にさかのぼり抽出。
   * 切り替えタブ or セクション下部に折り畳み表示。

### 4.3 操作

* **変更不可**（目的アイテム変更のみツリー画面から実施）。

---

## 5. 今後の TODO（バックログ）

| 優先度 | 項目         | 説明                        |
| --- | ---------- | ------------------------- |
| ★   | 流体アイテム対応   | 数量小数・容器返却等の UI／進捗定義       |
| ★   | 確率ドロップ表示   | 必要数×期待値を表示し、「確率○%」バッジで明示  |
| ☆   | パフォーマンス最適化 | 数千ノード時に Lazy レンダリング／メモリ削減 |
| ☆   | 大規模ツリー検索   | アイテム名検索・ミニマップ表示など UX 改善   |
| ☆   | デバッグツール    | 強制完了・レシピ強制アンロック機能         |

