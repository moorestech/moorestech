# moorestechプロジェクト イントロダクション

このドキュメントは、moorestechプロジェクトに新たに参加するエンジニア向けの包括的なイントロダクションです。プロジェクトの概要、アーキテクチャ、主要モジュール、開発環境のセットアップなどについて説明します。

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [サーバー側の主要モジュール](#サーバー側の主要モジュール)
4. [クライアント側の主要モジュール](#クライアント側の主要モジュール)
5. [通信プロトコル](#通信プロトコル)
6. [ゲームの主要機能](#ゲームの主要機能)
7. [開発環境のセットアップ](#開発環境のセットアップ)
8. [ビルドと実行方法](#ビルドと実行方法)
9. [デバッグ方法](#デバッグ方法)
10. [コーディング規約](#コーディング規約)

## プロジェクト概要

moorestechは自動化工業ゲームで、プレイヤーはリソースを収集し、機械を構築し、生産ラインを自動化することができます。ゲームは以下の2つの主要なUnityプロジェクトで構成されています：

- **moorestech_server**: ゲームロジックを処理するサーバー
- **moorestech_client**: ユーザーインターフェースとプレイヤー操作を処理するクライアント

このゲームはクライアント・サーバーアーキテクチャを採用しており、サーバーがゲームの状態を管理し、クライアントはその状態を表示します。

## アーキテクチャ

### 全体アーキテクチャ

moorestechは以下のようなアーキテクチャを採用しています：

```
+-------------------+        +-------------------+
|                   |        |                   |
|  moorestech_client|<------>|  moorestech_server|
|  (Unity)          |  TCP   |  (Unity)          |
|                   |        |                   |
+-------------------+        +-------------------+
```

- **サーバー**: ゲームロジック全般を処理します。機械の加工、発電、ベルトコンベアのアイテム移動処理、アイテムの搬出入、プレイヤーのインベントリ管理、チャレンジの管理、アイテムやレシピのアンロック状況の管理などを行います。
- **クライアント**: プレイヤーが触る処理全般を行います。サーバーとの接続、UIの表示、プレイヤー操作、ブロックの表示などを担当します。クライアントは積極的に情報を持たず、サーバーから必要な情報だけを受け取り、プレイヤーに提示する形になっています。

### 依存性注入

moorestechでは、依存性注入（DI）パターンを採用しています。サーバー側では`Microsoft.Extensions.DependencyInjection`を、クライアント側では`VContainer`を使用しています。

## サーバー側の主要モジュール

サーバー側のコードは`moorestech_server/Assets/Scripts`ディレクトリに配置されており、以下の主要なモジュールで構成されています：

### Core系モジュール

基本的なシステムを提供します：

- **Core.Inventory**: インベントリシステムの基本機能を提供します。
- **Core.Item**: アイテムシステムの基本機能を提供します。
- **Core.Item.Interface**: アイテムシステムのインターフェースを定義します。
- **Core.Master**: マスターデータ管理機能を提供します。
- **Core.Update**: ゲームの更新処理を管理します。

### Game系モジュール

ゲームの具体的な機能を実装します：

- **Game.Block**: ブロック関連の機能を実装します。
- **Game.Block.Interface**: ブロックのインターフェースを定義します。
- **Game.Challenge**: チャレンジ関連の機能を実装します。
- **Game.Context**: ゲームのコンテキスト（サービスロケーター）を提供します。
- **Game.CraftChainer**: クラフトチェイン関連の機能を実装します。
- **Game.Crafting.Interface**: クラフト関連のインターフェースを定義します。
- **Game.EnergySystem**: エネルギーシステム関連の機能を実装します。
- **Game.Entity**: エンティティ関連の機能を実装します。
- **Game.Fluid**: 流体関連の機能を実装します。
- **Game.Gear**: ギア関連の機能を実装します。
- **Game.Map**: マップ関連の機能を実装します。
- **Game.PlayerInventory**: プレイヤーインベントリ関連の機能を実装します。
- **Game.SaveLoad**: セーブ・ロード関連の機能を実装します。
- **Game.Train**: 列車関連の機能を実装します。
- **Game.UnlockState**: アンロック状態関連の機能を実装します。
- **Game.World**: ワールド関連の機能を実装します。

### Server系モジュール

サーバー関連の機能を実装します：

- **Server.Boot**: サーバーの起動処理を実装します。
- **Server.Event**: サーバーイベント関連の機能を実装します。
- **Server.Protocol**: 通信プロトコル関連の機能を実装します。
- **Server.Util**: サーバーユーティリティ関連の機能を実装します。

### Mod系モジュール

MOD関連の機能を実装します：

- **Mod.Base**: MODの基本機能を提供します。
- **Mod.Config**: MODの設定関連の機能を実装します。
- **Mod.Loader**: MODのロード関連の機能を実装します。

## クライアント側の主要モジュール

クライアント側のコードは`moorestech_client/Assets/Scripts`ディレクトリに配置されており、以下の主要なモジュールで構成されています：

### Client系モジュール

- **Client.Common**: 共通機能を提供します。
- **Client.CutScene**: カットシーン関連の機能を実装します。
- **Client.DebugSystem**: デバッグシステム関連の機能を実装します。
- **Client.Game**: ゲーム関連の機能を実装します。
  - **Client.Game.InGame**: ゲームプレイ中の機能を実装します。
    - **Client.Game.InGame.Block**: ブロック関連の機能を実装します。
    - **Client.Game.InGame.BlockSystem**: ブロックシステム関連の機能を実装します。
    - **Client.Game.InGame.Control**: 制御関連の機能を実装します。
    - **Client.Game.InGame.Electric**: 電気関連の機能を実装します。
    - **Client.Game.InGame.Entity**: エンティティ関連の機能を実装します。
    - **Client.Game.InGame.Map**: マップ関連の機能を実装します。
    - **Client.Game.InGame.Mining**: 採掘関連の機能を実装します。
    - **Client.Game.InGame.Player**: プレイヤー関連の機能を実装します。
    - **Client.Game.InGame.UI**: UI関連の機能を実装します。
    - **Client.Game.InGame.World**: ワールド関連の機能を実装します。
- **Client.Input**: 入力関連の機能を実装します。
- **Client.Localization**: ローカライゼーション関連の機能を実装します。
- **Client.MainMenu**: メインメニュー関連の機能を実装します。
- **Client.Mod**: MOD関連の機能を実装します。
- **Client.Network**: ネットワーク関連の機能を実装します。
- **Client.Skit**: スキット関連の機能を実装します。
- **Client.Starter**: 起動関連の機能を実装します。

## 通信プロトコル

moorestechでは、MessagePackを使用してクライアントとサーバー間の通信を行っています。通信は以下のように行われます：

1. クライアントがサーバーに接続します（`ServerCommunicator.CreateConnectedInstance`）。
2. クライアントがサーバーにリクエストを送信します（`PacketSender.Send`）。
3. サーバーがリクエストを処理し、レスポンスを返します。
4. クライアントがレスポンスを受信し、処理します（`PacketExchangeManager.ExchangeReceivedPacket`）。

主な通信クラスは以下の通りです：

- **ServerCommunicator**: サーバーとの通信を担当します。
- **PacketExchangeManager**: パケットの交換を管理します。
- **PacketSender**: パケットの送信を担当します。
- **VanillaApi**: サーバーとの通信APIを提供します。

## ゲームの主要機能

### ブロックシステム

ブロックは、ゲーム内の基本的な建築要素です。ブロックには以下のような種類があります：

- 機械ブロック（加工、発電など）
- ベルトコンベアブロック
- ストレージブロック
- その他の機能ブロック

ブロックは`IBlock`インターフェースを実装し、様々なコンポーネントを持つことができます。主なコンポーネントは以下の通りです：

- **IBlockInventory**: ブロックのインベントリを管理します。
- **IBlockConnectorComponent**: ブロック間の接続を管理します。
- **IUpdatableBlockComponent**: 更新可能なブロックコンポーネントを表します。

### アイテムシステム

アイテムは、ゲーム内のリソースや製品を表します。アイテムは`IItemStack`インターフェースを実装し、以下のような機能を持ちます：

- アイテムの追加・削除
- アイテムのスタック
- アイテムのメタデータ管理

### インベントリシステム

インベントリは、アイテムを保持する場所です。インベントリには以下のような種類があります：

- プレイヤーインベントリ
- ブロックインベントリ
- クラフトインベントリ

インベントリは`IOpenableInventory`インターフェースを実装し、以下のような機能を持ちます：

- アイテムの取得・設定
- アイテムの挿入・取り出し
- インベントリの開閉

### クラフトシステム

クラフトは、アイテムを組み合わせて新しいアイテムを作成する機能です。クラフトには以下のような種類があります：

- 通常クラフト
- 全クラフト
- 1スタッククラフト

クラフトは`ICraftingOpenableInventory`インターフェースを実装し、以下のような機能を持ちます：

- クラフト可能かどうかの確認
- クラフト処理の実行
- クラフト結果の取得

### チャレンジシステム

チャレンジは、プレイヤーに目標を提供する機能です。チャレンジには以下のような種類があります：

- ブロック設置チャレンジ
- アイテム作成チャレンジ
- インベントリ内アイテムチャレンジ

チャレンジは`IChallengeTask`インターフェースを実装し、以下のような機能を持ちます：

- チャレンジの完了確認
- チャレンジの更新処理
- チャレンジ完了時のイベント通知

### アンロックシステム

アンロックは、ゲームの進行に応じて新しい機能やアイテムを解放する機能です。アンロックには以下のような種類があります：

- クラフトレシピのアンロック
- アイテムのアンロック

アンロックは`IGameUnlockStateDataController`インターフェースを実装し、以下のような機能を持ちます：

- アンロック状態の管理
- アンロックイベントの通知
- アンロック状態の保存・読み込み

## 開発環境のセットアップ

### 必要なソフトウェア

- Unity 2022.3.x以降
- Visual Studio 2022または同等のIDE
- Git

### リポジトリのクローン

```bash
git clone https://github.com/moorestech/moorestech.git
cd moorestech
```

### サブツリーの設定

```bash
git remote add schema git@github.com:moorestech/VanillaSchema.git
git fetch schema
git subtree add --prefix=schema --squash schema main
```

## ビルドと実行方法

### Unityでの実行

1. Unity Hubを開き、`moorestech_server`プロジェクトを開きます。
2. Playボタンをクリックしてサーバーを起動します。
3. 別のUnityインスタンスで`moorestech_client`プロジェクトを開きます。
4. MainGameシーンを開きます。
5. Playボタンをクリックしてクライアントを起動します。

## デバッグ方法

### サーバーのデバッグ

サーバーのデバッグは、Unityのデバッグ機能を使用して行います。主なデバッグ方法は以下の通りです：

- Unityのコンソールでログを確認する
- ブレークポイントを設定してコードの実行を一時停止する
- 変数の値を確認する

### クライアントのデバッグ

クライアントのデバッグも、Unityのデバッグ機能を使用して行います。主なデバッグ方法は以下の通りです：

- Unityのコンソールでログを確認する
- ブレークポイントを設定してコードの実行を一時停止する
- 変数の値を確認する
- クライアント側のデバッグUIを使用する

## コーディング規約

moorestechプロジェクトでは、以下のコーディング規約を採用しています：

### 命名規則

- クラス名: PascalCase（例: `BlockInventory`）
- メソッド名: PascalCase（例: `GetItem`）
- プロパティ名: PascalCase（例: `ItemId`）
- 変数名: camelCase（例: `itemStack`）
- プライベートフィールド: _camelCase（例: `_blockComponents`）
- インターフェース名: IPascalCase（例: `IBlock`）
- 定数: UPPER_CASE（例: `MAX_STACK_SIZE`）

### コードスタイル

- インデントにはスペースを使用します。
- 中括弧は新しい行に配置します。
- メソッドの間には空行を入れます。
- コメントは日本語と英語の両方で記述します。
- 複雑なロジックには説明コメントを追加します。

### アーキテクチャガイドライン

- 依存性注入を使用して、コンポーネント間の結合度を低くします。
- インターフェースを使用して、実装の詳細を隠蔽します。
- 単一責任の原則に従い、クラスは1つの責任のみを持つようにします。
- イベント駆動型のアーキテクチャを採用し、コンポーネント間の通信にはObservableを使用します。

以上がmoorestechプロジェクトの基本的なイントロダクションです。詳細な情報については、各モジュールのコードやコメントを参照してください。