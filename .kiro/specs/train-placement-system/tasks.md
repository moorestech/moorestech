# 実装計画 - 列車配置システム

## 概要

この実装計画は、クライアント側から列車をレール上に配置できるシステムを段階的に構築するためのタスクリストです。既存のPlaceSystemアーキテクチャとプロトコルパターンを活用し、サーバー側の検証・生成ロジックとクライアント側のUI/UXを統合します。

## 実装タスク

- [ ] 1. テスト環境とマスターデータの準備
- [ ] 1.1 テスト用列車アイテムとマスターデータを作成
  - ForUnitTestModのマスターデータに列車アイテムを追加
  - 列車アイテムのID定義をテストモジュールに追加
  - 列車の長さ、車両数、その他必要なパラメータを設定
  - テスト用レールブロックが既に存在することを確認
  - _Requirements: 11.5_

- [ ] 1.2 PlaceSystemMasterに列車配置モードを登録
  - PlaceSystemMasterスキーマに新しいPlaceMode（TrainCar）を定義
  - 列車アイテムをPlaceSystemMasterに登録
  - UsePlaceItemsフィールドに列車アイテムのGuidを設定
  - マスターデータJSONに列車配置用のエントリを追加
  - _Requirements: 9.1, 9.2, 9.4_

- [ ] 2. サーバー側通信データ構造の実装
- [ ] 2.1 列車配置リクエストのメッセージ構造を定義
  - プロトコルタグ、レール位置指定子、列車アイテムID、プレイヤーIDを含むリクエストデータを作成
  - MessagePack属性とKey属性を適切に設定
  - デシリアライズ用の引数なしコンストラクタを実装
  - 既存のRailComponentSpecifierを再利用
  - _Requirements: 4.2, 5.1, 5.3, 5.4, 5.5_

- [ ] 2.2 列車配置レスポンスのメッセージ構造を定義
  - 成功/失敗フラグ、エラーメッセージ、生成された列車IDを含むレスポンスデータを作成
  - MessagePack属性とKey属性を適切に設定
  - デシリアライズ用の引数なしコンストラクタを実装
  - 成功時と失敗時で適切なフィールドが設定されるよう設計
  - _Requirements: 4.7, 4.8, 5.2, 5.3, 5.4, 5.5_

- [ ] 3. サーバー側プロトコルとビジネスロジックの実装
- [ ] 3.1 プロトコルの基本構造と検証ロジックを実装
  - プロトコルクラスを作成し、リクエストのデシリアライズを実装
  - RailComponentSpecifierの有効性を検証
  - プレイヤーIDの有効性を確認
  - 列車アイテムIDがマスターデータに存在するか検証
  - エラー時は適切なエラーメッセージを含むレスポンスを返却
  - _Requirements: 4.1, 4.3, 10.1, 10.4, 10.5_

- [ ] 3.2 レールグラフからレール情報を取得する機能を実装
  - RailGraphDatastoreからRailComponentSpecifierに対応するRailComponentを取得
  - RailComponentからRailNodeリストを抽出
  - レールノードが存在しない場合のエラーハンドリングを実装
  - 駅レールの場合の特別な処理を考慮（将来拡張のための準備）
  - _Requirements: 2.1, 2.2, 2.4, 7.1, 7.2, 7.4, 7.5_

- [ ] 3.3 プレイヤーインベントリの検証を実装
  - プレイヤーのインベントリから列車アイテムを検索
  - アイテムが存在しない場合のエラーハンドリングを実装
  - インベントリから列車アイテムを削除する機能を実装
  - アイテム削除は列車生成成功後のみ実行
  - _Requirements: 4.3, 4.6, 10.2, 10.5_

- [ ] 3.4 列車の重複配置チェックを実装
  - 指定されたレール位置に既に列車が存在するか確認
  - 既存列車の検出方法を実装（TrainRailPositionManagerを活用）
  - 重複が検出された場合のエラーハンドリングを実装
  - _Requirements: 1.6, 4.3, 10.3, 10.5_

- [ ] 3.5 列車生成とRailPosition初期化を実装
  - 取得したRailNodeリストからRailPositionを生成
  - initialDistanceToNextNodeを0で初期化
  - 列車の長さをTrainCarリストから計算
  - 列車の初期速度を0に設定
  - 自動運転を無効に設定
  - TrainCarリストを生成（マスターデータに基づく）
  - TrainUnitを生成し、自動的にTrainUpdateServiceに登録
  - _Requirements: 2.4, 4.4, 4.5, 7.3, 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 3.6 成功レスポンスの生成と返却を実装
  - 列車生成成功時に生成された列車IDを含むレスポンスを作成
  - IsSuccessをtrueに設定
  - TrainIdフィールドに生成された列車のGuidを設定
  - レスポンスをシリアライズして返却
  - _Requirements: 4.7_

- [ ] 4. プロトコルの登録と統合
- [ ] 4.1 PacketResponseCreatorへのプロトコル登録
  - PacketResponseCreatorのコンストラクタに新しいプロトコルを登録
  - プロトコルタグ"va:place_train_on_rail"を使用
  - プロトコルタグの一意性を確認
  - 依存関係の注入を適切に設定
  - _Requirements: 6.1, 6.2_

- [ ] 5. クライアント側配置システムの中核機能を実装
- [ ] 5.1 列車配置システムの基本構造を作成
  - PlaceSystemインターフェースを実装した列車配置システムを作成
  - Enable、Disable、ManualUpdateメソッドを実装
  - カメラとプレビューコントローラへの依存関係を設定
  - システムの有効化・無効化時の状態管理を実装
  - _Requirements: 1.1, 1.5_

- [ ] 5.2 レールブロック検出とレイキャストを実装
  - マウスカーソル位置からレイを発射
  - レイがレールブロックに当たるか判定
  - 当たったブロックがレールブロックか確認
  - レールブロックの座標を取得
  - レールが検出できない場合の処理を実装
  - _Requirements: 1.2, 1.4, 2.1, 2.3_

- [ ] 5.3 レール位置指定子の生成を実装
  - レイキャストで取得したブロック座標からRailComponentSpecifierを生成
  - CreateRailSpecifierメソッドを使用（既存の実装を再利用）
  - 複数のレールコンポーネントが存在する場合の選択ロジックを実装
  - _Requirements: 2.2, 2.3, 2.5_

- [ ] 5.4 クリックイベントとプロトコル送信を実装
  - InputManagerからクリックイベントを検出
  - クリック時にレール位置が有効か確認
  - ClientContext.VanillaApiを通じてプロトコルを送信
  - 列車アイテムIDとプレイヤーIDを含めて送信
  - レスポンス受信後の処理を実装（ログ出力等）
  - _Requirements: 1.3, 4.8, 10.6_

- [ ] 6. クライアント側プレビュー機能の実装
- [ ] 6.1 プレビュー用GameObjectの管理機能を作成
  - 列車モデルをAddressablesからロード
  - プレビュー用GameObjectの生成と破棄を管理
  - プレビューの表示・非表示を制御
  - 列車アイテムIDに基づいて適切なモデルを選択
  - _Requirements: 3.1, 3.4_

- [ ] 6.2 プレビューの位置更新と色変更を実装
  - レイキャストで取得した位置にプレビューを配置
  - 配置可能な場合は緑色、不可能な場合は赤色に設定
  - カーソル移動に応じてリアルタイムで位置を更新
  - レールの向きに合わせてプレビューの回転を設定
  - _Requirements: 3.2, 3.3, 3.5, 8.5_

- [ ] 6.3 プレビューシステムと配置システムの統合
  - ManualUpdateメソッド内でプレビュー更新を呼び出し
  - レール検出成功時にプレビューを表示
  - レール検出失敗時にプレビューを非表示
  - システム無効化時にプレビューをクリーンアップ
  - _Requirements: 1.2, 1.4, 1.5_

- [ ] 7. PlaceSystemSelectorとDI登録の統合
- [ ] 7.1 PlaceSystemSelectorに列車配置システムを追加
  - PlaceSystemSelectorに列車配置システムへの参照を追加
  - GetCurrentPlaceSystemメソッドで列車アイテム検出ロジックを実装
  - PlaceSystemMasterから列車配置モードを取得
  - TrainCarモードの場合に列車配置システムを返却
  - _Requirements: 9.1, 9.3_

- [ ] 7.2 依存性注入の設定を実装
  - MainGameStarterに列車配置システムをDI登録
  - Singletonライフタイムで登録
  - PlaceSystemSelectorのコンストラクタに列車配置システムを注入
  - 必要な依存関係（Camera、プレビューコントローラ等）を設定
  - _Requirements: 9.5_

- [ ] 8. サーバー側テストの実装
- [ ] 8.1 プロトコルの正常系テストを作成
  - 有効なリクエストで列車が正常に配置されるテストを実装
  - レスポンスのIsSuccessがtrueであることを確認
  - TrainIdが返却されることを確認
  - プレイヤーのインベントリからアイテムが削除されることを確認
  - TrainUpdateServiceに列車が登録されることを確認
  - _Requirements: 11.1, 11.2_

- [ ] 8.2 プロトコルの異常系テストを作成（無効なレール位置）
  - 存在しないブロック座標でプロトコルを呼び出すテストを実装
  - レスポンスのIsSuccessがfalseであることを確認
  - 適切なエラーメッセージが返却されることを確認
  - ゲーム状態が変更されていないことを確認
  - _Requirements: 11.3_

- [ ] 8.3 プロトコルの異常系テストを作成（インベントリ不足）
  - プレイヤーのインベントリが空の状態でプロトコルを呼び出すテストを実装
  - レスポンスのIsSuccessがfalseであることを確認
  - インベントリ不足のエラーメッセージが返却されることを確認
  - 列車が生成されていないことを確認
  - _Requirements: 11.3_

- [ ] 8.4 プロトコルの異常系テストを作成（列車重複）
  - 既に列車が配置されているレール位置で再度プロトコルを呼び出すテストを実装
  - レスポンスのIsSuccessがfalseであることを確認
  - 列車重複のエラーメッセージが返却されることを確認
  - 新しい列車が生成されていないことを確認
  - _Requirements: 11.3_

- [ ] 8.5 TrainUnit生成とRailPosition初期化のテストを作成
  - 列車配置後、TrainUnit.RailPositionを確認するテストを実装
  - RailNodeリストが正しく設定されていることを確認
  - initialDistanceToNextNodeが0であることを確認
  - 列車の長さが正しく計算されていることを確認
  - 初期速度が0、自動運転が無効であることを確認
  - _Requirements: 11.1, 11.2_

- [ ] 8.6 RailGraph統合テストを作成
  - RailGraphDatastoreにレールを登録し、プロトコルを呼び出すテストを実装
  - 正しいRailComponentが取得されることを確認
  - RailNodeリストが正しく抽出されることを確認
  - TrainUnitのRailPositionに正しいノードが設定されることを確認
  - _Requirements: 11.1_

- [ ] 9. クライアント側統合とエンドツーエンド検証
- [ ] 9.1 クライアント側の手動テスト手順を文書化
  - 列車アイテム選択時の動作確認手順を記述
  - プレビュー表示の確認手順を記述
  - レールクリック時の配置実行確認手順を記述
  - PlaceSystem切り替えの確認手順を記述
  - _Requirements: 11.4_

- [ ] 9.2 ClientContext.VanillaApiにプロトコル送信メソッドを追加
  - PlaceTrainOnRail送信用のメソッドを実装
  - リクエストのシリアライズを実装
  - レスポンスのデシリアライズを実装
  - エラー時のログ出力を実装
  - _Requirements: 6.3, 6.4_

- [ ] 9.3 統合動作確認とデバッグログの追加
  - クライアントからサーバーへのプロトコル送信を確認
  - サーバー側で列車が生成されることを確認
  - クライアント側でレスポンスを受信することを確認
  - エラーケースのログ出力を確認
  - プレビュー表示と配置実行の一連の流れを確認
  - _Requirements: 全要件の統合検証_

## 要件カバレッジマトリクス

| 要件 | カバーしているタスク |
|------|---------------------|
| 要件1: TrainCarPlaceSystem | 5.1, 5.2, 6.3, 7.1 |
| 要件2: レール上の配置位置計算 | 3.2, 5.2, 5.3 |
| 要件3: プレビュー表示システム | 6.1, 6.2, 6.3 |
| 要件4: PlaceTrainOnRailProtocol | 2.1, 2.2, 3.1, 3.3, 3.5, 3.6, 5.4 |
| 要件5: MessagePackデータ構造 | 2.1, 2.2 |
| 要件6: プロトコル登録と統合 | 4.1, 9.2 |
| 要件7: RailGraph統合 | 3.2, 8.6 |
| 要件8: 列車の初期状態設定 | 3.5, 6.2, 8.5 |
| 要件9: PlaceSystemSelector統合 | 1.2, 7.1, 7.2 |
| 要件10: エラーハンドリング | 3.1, 3.3, 3.4 |
| 要件11: テストカバレッジ | 1.1, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 9.1 |

## 実装の進め方

1. **サーバー側から実装**: サーバー側のプロトコルとビジネスロジックを先に実装し、テストで動作を確認
2. **クライアント側の実装**: サーバー側が完成した後、クライアント側の配置システムとプレビューを実装
3. **統合とテスト**: 最後にクライアント・サーバー間の統合を確認し、エンドツーエンドで動作を検証

各タスクは1〜3時間程度で完了できるよう設計されています。タスク完了後は必ずコンパイルとテストを実行し、動作を確認してください。
