# 実装計画

## Phase 1: サーバー側基盤実装

- [ ] 1. 共通データ型とenumの定義
  - インベントリタイプを識別するenumを定義（Block、Train）
  - インベントリ識別子を保持するデータ構造を定義
  - イベントタイプを識別するenumを定義（Update、Remove）
  - MessagePack属性を設定し、シリアライゼーション可能にする
  - _要件: 1.3, 1.4, 1.5, 1.6, 2.2, 2.4, 2.5_

- [ ] 2. サブスクリプション状態管理システムの実装
- [ ] 2.1 サブスクリプションストアインターフェースの定義
  - サブスクライバー取得機能を提供するインターフェースを定義
  - サブスクリプション登録・解除機能を提供するインターフェースを定義
  - 現在のサブスクリプション状態を照会する機能を定義
  - プレイヤーIDとインベントリの紐付けを管理するデータ構造を設計
  - _要件: 2.6_

- [ ] 2.2 サブスクリプションストアの実装
  - プレイヤーIDとインベントリの紐付けを管理する内部状態を実装
  - インベントリごとのサブスクライバーリストを管理する内部状態を実装
  - 1プレイヤー1サブスクリプションの制約を実装
  - 既存サブスクリプションの上書き処理を実装
  - nullチェックとバリデーションロジックを実装
  - _要件: 2.6_

- [ ] 2.3 サブスクリプションストアのテスト
  - サブスクリプション登録の正常系テストを作成
  - サブスクリプション解除の正常系テストを作成
  - 重複サブスクリプションの上書きテストを作成
  - サブスクライバーリスト取得のテストを作成
  - 存在しないインベントリのサブスクライバー取得の境界値テストを作成
  - _要件: 7.1, 7.2_

- [ ] 3. 統一サブスクリプションプロトコルの実装
- [ ] 3.1 サブスクリプションリクエストの処理実装
  - IPacketResponseを実装したプロトコルクラスを作成
  - MessagePackリクエストのデシリアライズ処理を実装
  - インベントリタイプと識別子の整合性チェックを実装
  - サブスクライブフラグによる登録・解除の分岐処理を実装
  - サブスクリプションストアへの委譲処理を実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3.2 PacketResponseCreatorへの登録
  - プロトコルタグを定義（"va:invSubscribe"）
  - PacketResponseCreatorのコンストラクタにプロトコルを登録
  - DIコンテナへの依存関係登録を実装
  - _要件: 2.1_

- [ ] 3.3 サブスクリプションプロトコルのテスト
  - ブロックインベントリのサブスクリプション正常系テストを作成
  - 列車インベントリのサブスクリプション正常系テストを作成
  - サブスクリプション解除の正常系テストを作成
  - 存在しないインベントリのサブスクリプション異常系テストを作成
  - 無効な識別子の処理異常系テストを作成
  - _要件: 7.1, 7.2_

- [ ] 4. 統一インベントリ更新イベントパケットの実装
- [ ] 4.1 イベントパケットクラスの実装
  - EventTagを定義（"va:event:invUpdate"）
  - MessagePackイベントペイロードの構造を実装
  - 更新イベントと削除イベントの両方に対応するペイロード設計を実装
  - EventProtocolProviderへのイベント追加処理を実装
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 4.2 イベント配信ロジックの実装
  - サブスクリプションストアからサブスクライバーを取得する処理を実装
  - サブスクライバーごとにイベントペイロードを送信する処理を実装
  - サブスクライバーがいない場合の早期リターン処理を実装
  - イベントタイプによる条件分岐処理を実装
  - _要件: 1.1, 1.2_

- [ ] 4.3 イベントパケットのテスト
  - ブロックインベントリ更新イベント送信の正常系テストを作成
  - 列車インベントリ更新イベント送信の正常系テストを作成
  - インベントリ削除通知送信の正常系テストを作成
  - 複数サブスクライバーへのイベント配信テストを作成
  - サブスクライバーがいない場合の境界値テストを作成
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ] 5. サーバー側コンパイルと初期検証
  - MCPツールでサーバー側のコンパイルを実行
  - コンパイルエラーがないことを確認
  - すべての単体テストを実行して成功を確認
  - _要件: すべての要件（Phase 1完了確認）_

## Phase 2: サーバー側システム統合

- [ ] 6. ブロックシステムとの統合
- [ ] 6.1 ブロックインベントリ更新イベントの接続
  - ブロックインベントリ更新イベントを購読する処理を実装
  - ブロック座標からインベントリ識別子を生成する処理を実装
  - 統一イベントパケットへのイベント通知処理を実装
  - 更新イベントタイプを設定してペイロードを構築
  - _要件: 1.1, 1.5_

- [ ] 6.2 ブロック削除イベントの接続
  - ブロック削除イベントを購読する処理を実装
  - サブスクライバーが存在するブロックの削除を検知する処理を実装
  - 削除通知イベントタイプを設定してペイロードを構築
  - 統一イベントパケットへの削除通知処理を実装
  - _要件: 1.2, 1.4, 1.5_

- [ ] 6.3 ブロックシステム統合のテスト
  - ブロックインベントリ更新時にイベントが送信されることをテスト
  - ブロック削除時に削除通知が送信されることをテスト
  - サブスクライバーがいないブロックの更新・削除をテスト
  - _要件: 7.1, 7.3_

- [ ] 7. 列車システムとの統合
- [ ] 7.1 列車インベントリ更新イベントの接続
  - 列車インベントリ更新イベントを購読する処理を実装
  - 列車IDからインベントリ識別子を生成する処理を実装
  - 統一イベントパケットへのイベント通知処理を実装
  - 更新イベントタイプを設定してペイロードを構築
  - _要件: 1.1, 1.6_

- [ ] 7.2 列車削除イベントの接続
  - 列車削除イベントを購読する処理を実装
  - サブスクライバーが存在する列車の削除を検知する処理を実装
  - 削除通知イベントタイプを設定してペイロードを構築
  - 統一イベントパケットへの削除通知処理を実装
  - _要件: 1.2, 1.4, 1.6_

- [ ] 7.3 列車システム統合のテスト
  - 列車インベントリ更新時にイベントが送信されることをテスト
  - 列車削除時に削除通知が送信されることをテスト
  - サブスクライバーがいない列車の更新・削除をテスト
  - _要件: 7.2, 7.4_

- [ ] 8. サーバー側統合テストと検証
  - エンドツーエンドのサブスクリプションフローをテスト
  - 複数プレイヤーのサブスクリプションシナリオをテスト
  - サブスクリプション切り替えシナリオをテスト
  - MCPツールでサーバー側の全テストを実行して成功を確認
  - _要件: すべての要件（Phase 2完了確認）_

## Phase 3: クライアント側基盤実装

- [ ] 9. インベントリソース識別システムの実装
- [ ] 9.1 インベントリソースインターフェースの定義
  - インベントリタイプを返すメソッドを定義
  - インベントリ識別子を返すメソッドを定義
  - 使用するビュータイプを返すメソッドを定義
  - Addressableパスを返すメソッドを定義
  - インベントリデータ取得用の非同期メソッドを定義
  - _要件: 4.1, 4.2, 4.3_

- [ ] 9.2 ブロックインベントリソースの実装
  - BlockGameObjectを受け取るコンストラクタを実装
  - ブロック座標からインベントリ識別子を生成する処理を実装
  - IBlockInventoryViewのタイプ情報を返す処理を実装
  - ブロックマスターからAddressableパスを取得する処理を実装
  - GetBlockInventory APIを呼び出すデータフェッチ処理を実装
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 9.3 列車インベントリソースの実装
  - TrainEntityObjectを受け取るコンストラクタを実装
  - 列車IDからインベントリ識別子を生成する処理を実装
  - ITrainInventoryViewのタイプ情報を返す処理を実装
  - 固定のAddressableパスを返す処理を実装
  - GetTrainInventory APIを呼び出すデータフェッチ処理を実装
  - _要件: 4.1, 4.2, 4.3, 4.5_

- [ ] 9.4 インベントリソースのテスト
  - ブロックインベントリソースのインベントリタイプ取得テスト
  - 列車インベントリソースのインベントリタイプ取得テスト
  - 識別子生成の正常系テスト
  - ビュータイプ取得の正常系テスト
  - データフェッチ処理の正常系テスト
  - _要件: 7.5, 7.6_

- [ ] 10. 統一インベントリビューインターフェースの実装
- [ ] 10.1 ISubInventoryViewインターフェースの定義
  - ISubInventoryインターフェースを継承する定義を作成
  - Initialize、UpdateItemList、UpdateInventorySlot、DestroyUIメソッドを定義
  - ジェネリックなInitialize(object)メソッドを定義
  - 型安全性を保つための設計を実装
  - _要件: 3.1, 3.2_

- [ ] 10.2 既存ビューインターフェースの継承関係変更
  - IBlockInventoryViewをISubInventoryViewを継承するように変更
  - ITrainInventoryViewをISubInventoryViewを継承するように変更
  - ブロック固有のInitialize(BlockGameObject)メソッドを保持
  - 列車固有のInitialize(TrainEntityObject)メソッドを保持
  - ジェネリックなInitialize(object)の実装を追加
  - _要件: 3.3, 3.4, 3.5_

- [ ] 10.3 ビューインターフェースのテスト
  - モックISubInventoryViewを使用したテストを作成
  - Initialize、UpdateItemList、UpdateInventorySlotの呼び出しテスト
  - 型安全なInitializeメソッドの呼び出しテスト
  - _要件: 7.5_

- [ ] 11. クライアント側API拡張
- [ ] 11.1 VanillaApiへのサブスクリプションメソッド追加
  - SubscribeInventoryメソッドをVanillaApiSendOnlyに追加
  - インベントリタイプと識別子を受け取るメソッドシグネチャを定義
  - 統一サブスクリプションリクエストのMessagePackを構築
  - PacketSenderを使用してサーバーに送信する処理を実装
  - _要件: 2.1, 2.2, 2.3_

- [ ] 11.2 イベントレスポンス購読の追加
  - 統一インベントリ更新イベントタグを定義
  - VanillaApiのEventレスポンスに購読処理を追加
  - イベントペイロードのデシリアライズ処理を実装
  - _要件: 1.1, 1.2_

- [ ] 12. クライアント側コンパイルと初期検証
  - MCPツールでクライアント側のコンパイルを実行
  - コンパイルエラーがないことを確認
  - すべての単体テストを実行して成功を確認
  - _要件: すべての要件（Phase 3基盤完了確認）_

## Phase 4: クライアント側UIステート統合

- [ ] 13. 統一サブインベントリUIステートの実装
- [ ] 13.1 UIステートの基本構造実装
  - IUIStateインターフェースを実装したSubInventoryStateクラスを作成
  - IInventorySource、ISubInventoryView、CancellationTokenSourceのフィールドを定義
  - OnEnter、GetNextUpdate、OnExitメソッドのシグネチャを実装
  - PlayerInventoryViewControllerへの依存関係を設定
  - _要件: 5.1_

- [ ] 13.2 インベントリオープン処理の実装
  - IInventorySourceからインベントリタイプを取得する処理を実装
  - IInventorySourceからAddressableパスを取得してUIをロードする処理を実装
  - ロードしたUIからISubInventoryViewを取得する処理を実装
  - 統一サブスクリプションプロトコルでサーバーにサブスクライブする処理を実装
  - IInventorySourceからインベントリデータをフェッチする処理を実装
  - フェッチしたデータでビューを初期化する処理を実装
  - _要件: 5.2, 5.3, 5.4_

- [ ] 13.3 インベントリ更新イベント処理の実装
  - 統一インベントリ更新イベントを購読する処理を実装
  - イベントペイロードをデシリアライズする処理を実装
  - イベントタイプ（Update/Remove）を判定する分岐処理を実装
  - 更新イベントの場合、ISubInventoryView.UpdateInventorySlotを呼び出す処理を実装
  - 削除イベントの場合、UIを自動的に閉じる処理を実装
  - _要件: 5.5, 5.6_

- [ ] 13.4 ブロック固有処理の実装
  - IBlockInventoryViewへの型チェック処理を実装
  - ブロック削除イベントの購読処理を実装
  - 開いているブロックが削除された場合のUI自動クローズ処理を実装
  - _要件: 5.7_

- [ ] 13.5 UIステート終了処理の実装
  - CancellationTokenSourceのキャンセル処理を実装
  - 統一サブスクリプションプロトコルでサブスクライブ解除する処理を実装
  - PlayerInventoryViewControllerのクリーンアップ処理を実装
  - ISubInventoryViewのDestroyUI呼び出し処理を実装
  - イベント購読の解除処理を実装
  - _要件: 5.8_

- [ ] 13.6 統一UIステートのテスト
  - ブロックインベントリオープンの正常系テストを作成
  - 列車インベントリオープンの正常系テストを作成
  - 更新イベント受信と処理の正常系テストを作成
  - 削除通知受信とUI自動クローズの正常系テストを作成
  - ロード中のキャンセル処理の異常系テストを作成
  - ネットワークエラー時の処理の異常系テストを作成
  - _要件: 7.5_

- [ ] 14. UIステート遷移の統合
- [ ] 14.1 GameScreenからの遷移処理更新
  - ブロッククリック時にBlockInventorySourceを生成する処理を実装
  - 列車クリック時にTrainInventorySourceを生成する処理を実装
  - 生成したIInventorySourceをSubInventoryStateに渡す処理を実装
  - UIStateControllerのステート遷移処理を更新
  - _要件: 4.4, 4.5, 4.6_

- [ ] 14.2 UIステート遷移のテスト
  - ブロッククリックからインベントリオープンまでの遷移テスト
  - 列車クリックからインベントリオープンまでの遷移テスト
  - インベントリ切り替え時の遷移テスト
  - _要件: 4.6, 5.1_

- [ ] 15. クライアント側統合テストと検証
  - エンドツーエンドのインベントリオープンフローをテスト
  - インベントリ更新イベントの受信と表示更新をテスト
  - インベントリ削除通知の受信とUI自動クローズをテスト
  - MCPツールでクライアント側の全テストを実行して成功を確認
  - _要件: すべての要件（Phase 4完了確認）_

## Phase 5: 既存実装の削除

- [ ] 16. サーバー側の既存実装削除
- [ ] 16.1 既存イベントパケットの削除
  - OpenableBlockInventoryUpdateEventPacket.csを削除
  - TrainInventoryUpdateEventPacket.csを削除
  - 関連するテストコードを削除
  - _要件: 6.1_

- [ ] 16.2 既存プロトコルとストアの削除
  - BlockInventoryOpenCloseProtocol.csを削除
  - IBlockInventoryOpenStateDataStore.csと実装クラスを削除
  - DIコンテナからの登録を削除
  - 関連するテストコードを削除
  - _要件: 6.1, 6.2_

- [ ] 16.3 サーバー側削除後のコンパイル確認
  - MCPツールでサーバー側のコンパイルを実行
  - コンパイルエラーがないことを確認
  - すべてのテストが成功することを確認
  - _要件: 6.1, 6.2_

- [ ] 17. クライアント側の既存実装削除
- [ ] 17.1 既存UIステートクラスの削除
  - BlockInventoryState.csを削除
  - TrainInventoryState.csを削除
  - 関連するテストコードを削除
  - _要件: 6.3_

- [ ] 17.2 既存API呼び出しメソッドの削除
  - VanillaApiSendOnly.SetOpenCloseBlockメソッドを削除
  - VanillaApiSendOnly.SetOpenCloseTrainメソッドを削除
  - 関連する参照を更新
  - _要件: 6.2, 6.4_

- [ ] 17.3 クライアント側削除後のコンパイル確認
  - MCPツールでクライアント側のコンパイルを実行
  - コンパイルエラーがないことを確認
  - すべてのテストが成功することを確認
  - _要件: 6.3, 6.4_

## Phase 6: 最終検証とクリーンアップ

- [ ] 18. 全体的なテスト実行と検証
- [ ] 18.1 サーバー側の全テスト実行
  - MCPツールですべての単体テストを実行
  - MCPツールですべての統合テストを実行
  - テスト結果を確認し、すべて成功していることを検証
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ] 18.2 クライアント側の全テスト実行
  - MCPツールですべての単体テストを実行
  - MCPツールですべての統合テストを実行
  - テスト結果を確認し、すべて成功していることを検証
  - _要件: 7.5, 7.6_

- [ ] 18.3 E2Eテストの実行
  - ブロックインベントリの使用シナリオをテスト
  - 列車インベントリの使用シナリオをテスト
  - 複数インベントリの操作シナリオをテスト
  - 実際のゲームプレイが正常に動作することを確認
  - _要件: すべての要件_

- [ ] 19. コードクリーンアップと最終確認
- [ ] 19.1 不要なimport文の削除
  - サーバー側のすべてのファイルをチェック
  - クライアント側のすべてのファイルをチェック
  - 未使用のusing文を削除
  - _要件: すべての要件_

- [ ] 19.2 最終コンパイル確認
  - MCPツールでサーバー側のコンパイルを実行
  - MCPツールでクライアント側のコンパイルを実行
  - すべてのコンパイルエラーがないことを確認
  - すべての警告を確認し、必要に応じて対応
  - _要件: すべての要件_

- [ ] 19.3 マイグレーション完了確認
  - すべての単体テストが成功していることを確認
  - すべての統合テストが成功していることを確認
  - E2Eテストでブロックインベントリが正常に動作することを確認
  - E2Eテストで列車インベントリが正常に動作することを確認
  - 既存のプロトコルとイベントパケットがすべて削除されていることを確認
  - コンパイルエラーがないことを確認
  - _要件: すべての要件_
