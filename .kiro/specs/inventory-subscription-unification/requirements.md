# 要件定義書

## はじめに
現在、ブロックインベントリと列車インベントリのシステムは、ほぼ同一の機能を持ちながらも、別々のプロトコル、イベントパケット、UIステートクラスとして実装されています。この重複により、保守性の低下、バグの増加リスク、新機能追加時の実装コストの増大といった問題が発生しています。

本機能では、これらのインベントリサブスクリプションシステムを統一的なアーキテクチャに抽象化することで、コードの重複を排除し、将来的な拡張性を確保します。具体的には、サーバー側のプロトコルとイベントパケットの統一、クライアント側のUIステートとインターフェースの共通化を行います。

## 要件

### 要件1: 統一インベントリ更新イベントプロトコル
**目的:** サーバー開発者として、ブロックと列車のインベントリ更新を統一されたイベントプロトコルで通知したい。これにより、新しいインベントリタイプ追加時の実装コストを削減できる。

#### 受入基準
1. WHEN サブスクライブされているインベントリ（ブロックまたは列車）のアイテムが更新された THEN サーバーは統一された形式でインベントリ更新イベントをクライアントに送信する SHALL
2. WHEN サブスクライブされているインベントリが削除された（ブロック破壊または列車削除） THEN サーバーはインベントリ削除通知イベントをクライアントに送信する SHALL
3. WHEN インベントリ更新イベントが送信される THEN イベントペイロードはインベントリタイプ（Block/Train）、インベントリ識別子、スロット番号、アイテム情報を含む SHALL
4. WHEN インベントリ削除通知イベントが送信される THEN イベントペイロードはインベントリタイプとインベントリ識別子を含む SHALL
5. WHERE ブロックインベントリの場合 THE インベントリ識別子はVector3Int型のブロック座標である SHALL
6. WHERE 列車インベントリの場合 THE インベントリ識別子はGuid型のTrainIdである SHALL

### 要件2: 統一インベントリサブスクリプションプロトコル
**目的:** クライアント開発者として、ブロックと列車のインベントリを統一されたプロトコルでサブスクライブしたい。これにより、クライアント側のAPI呼び出しコードが簡潔になる。

#### 受入基準
1. WHEN クライアントがインベントリを開く THEN 統一されたサブスクリプションプロトコルを使用してサーバーにサブスクライブリクエストを送信する SHALL
2. WHEN サブスクリプションリクエストが送信される THEN リクエストはインベントリタイプ（Block/Train）とタイプ別の識別子を含む SHALL
3. WHEN クライアントがインベントリを閉じる THEN 同じプロトコルを使用してサブスクライブ解除リクエストを送信する SHALL
4. IF インベントリタイプがBlockである THEN Vector3Int型のブロック座標を識別子として使用する SHALL
5. IF インベントリタイプがTrainである THEN Guid型のTrainIdを識別子として使用する SHALL
6. WHEN サーバーがサブスクリプションリクエストを受信する THEN 対応するプレイヤーIDとインベントリの紐付けを管理する SHALL

### 要件3: クライアント側インベントリビュー統一インターフェース
**目的:** UI開発者として、ブロックと列車のインベントリビューに共通のインターフェースを持たせたい。これにより、UIステートクラスでの処理を統一できる。

#### 受入基準
1. WHEN ISubInventoryViewインターフェースが定義される THEN ISubInventoryインターフェースを継承する SHALL
2. WHEN ISubInventoryViewインターフェースが定義される THEN Initialize、UpdateItemList、UpdateInventorySlot、DestroyUIメソッドを含む SHALL
3. WHEN ブロックインベントリビューが実装される THEN ISubInventoryViewインターフェースを実装する SHALL
4. WHEN 列車インベントリビューが実装される THEN ISubInventoryViewインターフェースを実装する SHALL
5. IF インベントリビューがブロック固有の機能を持つ THEN ブロック専用の追加インターフェース（IBlockInventoryView等）を併せて実装する SHALL
6. WHEN UpdateInventorySlotメソッドが呼ばれる THEN 指定されたスロット番号のアイテム表示を更新する SHALL

### 要件4: インベントリソース識別インターフェース
**目的:** システム設計者として、GameScreenステートからどのサブインベントリステートに遷移するか、どのISubInventoryViewを使用するかを選択する仕組みを定義したい。これにより、インベントリタイプごとの処理分岐を明確に管理できる。

#### 受入基準
1. WHEN インベントリソース識別インターフェースが定義される THEN インベントリタイプを返すメソッドを含む SHALL
2. WHEN インベントリソース識別インターフェースが定義される THEN インベントリ識別子（座標またはGuid）を返すメソッドを含む SHALL
3. WHEN インベントリソース識別インターフェースが定義される THEN 対応するISubInventoryView実装クラスの型情報を返すメソッドを含む SHALL
4. WHEN ブロックがクリックされる THEN ブロック用のインベントリソース識別オブジェクトが生成される SHALL
5. WHEN 列車がクリックされる THEN 列車用のインベントリソース識別オブジェクトが生成される SHALL
6. WHEN UIステート遷移が必要になる THEN インベントリソース識別オブジェクトを使用して適切なステートクラスとビューが選択される SHALL

### 要件5: 統一サブインベントリUIステート
**目的:** UIシステム設計者として、BlockInventoryStateとTrainInventoryStateを統合した単一のUIステートクラスを実装したい。これにより、重複コードを削減し、保守性を向上させる。

#### 受入基準
1. WHEN 統一サブインベントリUIステートクラスが実装される THEN BlockInventoryStateとTrainInventoryStateの機能を包含する SHALL
2. WHEN 統一UIステートがインベントリを開く THEN インベントリソース識別インターフェースを使用してインベントリタイプを判定する SHALL
3. WHEN 統一UIステートがインベントリビューを生成する THEN インベントリソース識別インターフェースから取得した型情報を使用する SHALL
4. WHEN 統一UIステートがサブスクリプションリクエストを送信する THEN 統一サブスクリプションプロトコルを使用する SHALL
5. WHEN 統一UIステートがインベントリ更新イベントを受信する THEN ISubInventoryViewインターフェースを通じてビューを更新する SHALL
6. WHEN 統一UIステートがインベントリ削除通知を受信する THEN UIを自動的に閉じる SHALL
7. IF ブロック固有の処理が必要である AND ビューがIBlockInventoryViewを実装している THEN ブロック専用メソッドを呼び出す SHALL
8. WHEN UIステートが終了する THEN サブスクリプション解除リクエストを送信しリソースを適切にクリーンアップする SHALL

### 要件6: 後方互換性とマイグレーション
**目的:** システム管理者として、既存のプロトコルから新しい統一プロトコルへの移行をスムーズに行いたい。ただし、プロジェクト方針により後方互換性の維持は不要である。

#### 受入基準
1. WHEN 新しい統一プロトコルが実装される THEN 既存のOpenableBlockInventoryUpdateEventPacketとTrainInventoryUpdateEventPacketは削除される SHALL
2. WHEN 新しい統一プロトコルが実装される THEN 既存のSetOpenCloseBlockとSetOpenCloseTrainメソッドは削除される SHALL
3. WHEN BlockInventoryStateとTrainInventoryStateが統合される THEN 既存の個別クラスは削除される SHALL
4. WHEN 統一システムが実装される THEN すべての既存のクライアントコードが新しいAPIを使用するように更新される SHALL

### 要件7: テスト容易性
**目的:** 品質保証担当者として、統一されたインベントリシステムが正しく動作することを検証したい。

#### 受入基準
1. WHEN ブロックインベントリがサブスクライブされる THEN 統一イベントプロトコルでインベントリ更新通知が送信されることをテストで検証できる SHALL
2. WHEN 列車インベントリがサブスクライブされる THEN 統一イベントプロトコルでインベントリ更新通知が送信されることをテストで検証できる SHALL
3. WHEN サブスクライブされたブロックが削除される THEN インベントリ削除通知が送信されることをテストで検証できる SHALL
4. WHEN サブスクライブされた列車が削除される THEN インベントリ削除通知が送信されることをテストで検証できる SHALL
5. WHEN 統一UIステートがテストされる THEN モックのISubInventoryViewを使用してテストできる SHALL
6. WHEN インベントリソース識別が必要になる THEN モックオブジェクトを使用してテストできる SHALL
