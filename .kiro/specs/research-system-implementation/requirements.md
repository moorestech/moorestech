# 要件定義書

## はじめに
本機能は、Moorestechゲームにおける研究システムの実装を行います。プレイヤーが研究ツリーを進めることで新しい技術やレシピをアンロックし、ゲームの進行を管理する重要なシステムです。研究の完了には必要なアイテムの消費が伴い、サーバーサイドで厳密な検証を行うことで、ゲームバランスとデータの整合性を保証します。

## 要件

### 要件1: 研究完了状態の管理
**ユーザーストーリー:** プレイヤーとして、研究を完了した状態が永続的に保存され、再ログイン後も進捗が維持されることを期待する

#### 受入基準

1. WHEN プレイヤーが研究を完了した THEN システムは研究完了状態をサーバーに永続化する
2. WHEN プレイヤーが再ログインした THEN システムは保存された研究完了状態を復元する
3. IF 研究ノードが既に完了済み THEN システムは同じ研究の重複完了を防止する
4. WHERE プレイヤーデータが存在する場所で THE システムは研究完了GUIDのコレクションを管理する
5. WHEN サーバーが再起動した THEN システムは全プレイヤーの研究データを正確に復元する

### 要件2: 前提条件の検証
**ユーザーストーリー:** プレイヤーとして、前提となる研究を完了していない場合、次の研究を開始できないようにしたい

#### 受入基準

1. IF 前提研究（prevResearchNodeGuid）が未完了 THEN システムは研究完了リクエストを拒否する
2. WHEN 前提研究が完了した THEN システムは依存する研究を利用可能状態にする
3. IF prevResearchNodeGuidが空（前提なし） THEN システムは研究を即座に利用可能とする
4. WHEN 研究完了可否をチェックする際 THEN システムは前提条件を再帰的に検証する

### 要件3: アイテム消費の処理
**ユーザーストーリー:** プレイヤーとして、研究を完了する際に必要なアイテムが自動的にインベントリから消費されることを期待する

#### 受入基準

1. WHEN 研究完了リクエストを受信した THEN システムは必要アイテムの所持数を検証する
2. IF 必要アイテムが不足している THEN システムは研究完了を拒否し、不足情報を返す
3. IF その研究がすでに完了している THEN システムは研究完了を拒否し、アイテムを消費しない
4. WHEN 全ての必要アイテムが揃っている THEN システムはアトミックにアイテムを消費する
5. IF アイテム消費処理中にエラーが発生した THEN システムは全ての変更をロールバックする
6. WHERE consumeItems配列で定義されたアイテム THE システムは正確な数量を消費する

### 要件4: 研究完了プロトコル
**ユーザーストーリー:** プレイヤーとして、研究完了ボタンを押した際に、即座にサーバーと通信して結果を受け取りたい

#### 受入基準

1. WHEN クライアントが研究完了ボタンを押した THEN システムはRequestCompleteResearchプロトコルを送信する
2. WHEN サーバーがリクエストを処理した THEN システムはNotifyResearchCompletedレスポンスを返す
3. IF 研究完了が成功した THEN システムは成功フラグと完了した研究GUIDを返す
4. IF 研究完了が失敗した THEN システムは失敗理由の詳細を含むエラーメッセージを返す
5. WHEN プレイヤーがログインした THEN システムはSyncPlayerResearchDataで完了済み研究を同期する

### 要件5: アクション実行システム
**ユーザーストーリー:** ゲームデザイナーとして、研究完了時に様々なアクション（レシピアンロック、報酬付与など）を自動実行したい

#### 受入基準

1. WHEN 研究が完了した THEN システムはclearedActionsで定義された全アクションを実行する
2. IF アクションがレシピアンロックの場合 THEN システムは指定レシピを利用可能にする
3. IF アクションがアイテム付与の場合 THEN システムはプレイヤーインベントリにアイテムを追加する
4. WHILE アクションを実行中 THE システムは各アクションの成功/失敗をログに記録する
5. IF アクション実行が失敗した THEN システムは研究完了自体をロールバックする

### 要件6: データ検証とセキュリティ
**ユーザーストーリー:** システム管理者として、不正な研究完了リクエストを防ぎ、データの整合性を保証したい

#### 受入基準

1. WHEN クライアントからリクエストを受信した THEN システムはサーバーサイドで全ての検証を実行する
2. IF 無効な研究GUIDが送信された THEN システムはリクエストを拒否しエラーログを記録する
3. WHERE サーバーサイドの検証で THE システムはクライアントから送信されたデータを信頼しない
4. WHEN 短時間に同一研究の完了リクエストが複数回送信された THEN システムは重複を防止する
5. IF 不正なリクエストパターンを検出した THEN システムは該当プレイヤーの行動をログに記録する