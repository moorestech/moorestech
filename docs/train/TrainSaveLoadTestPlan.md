# Train Save/Load Regression Checklist

以下は列車関連のセーブ・ロード機能を改修した後に実施すべきテスト項目です。テストケースは優先度順ではなく、シナリオごとに整理しています。

## 1. 基本的な復元確認
- レールグラフと駅ブロックを含む最小構成の環境を構築し、1編成だけを配置した状態でセーブ。
- ゲームを再起動してロードし、列車の位置・向き・速度が保存前と一致していることを確認。
- AutoRun を有効化した状態でセーブ→ロードし、`TrainUnit.IsAutoRun` が維持されているか、`DiagramValidation()` が自動で再実行されているかをチェック。

## 2. ダイアグラムと発車条件
- ダイアグラムに複数エントリを追加し、WaitForTicks を含む複数条件を設定した状態でセーブ。
- ロード後に `_currentIndex` と `DiagramEntry.entryId` が維持され、WaitForTicks の残り tick 数が継続されることをアサート。
- エントリに紐づく RailNode が欠損しているケースでは、そのエントリがスキップされつつ他のエントリが破壊されないことを確認。

## 3. 車両・インベントリ
- 貨車のインベントリおよび燃料スロットに複数種類のアイテムを格納した状態でセーブ。
- ロード後、スロット順序を含めて完全に復元されること、および `TrainCar.SetItem` / `SetFuelItem` が期待通り呼ばれることを確認。
- アイテムが無いスロットが空のまま維持されることも検証。

## 4. ドッキング状態
- 複数列車が同一駅に重なった状態でセーブし、ロード後に正しい編成だけが駅へ再ドッキングされるかをチェック。
- 駅ブロックをロード前に破壊したケースでは、該当車両の `dockingblock` が null にリセットされ、残りの車両のドッキングが影響を受けないことを確認。
- 自動運転 OFF の列車がドッキングしていた場合、ロード後も OFF のまま留まっていること。

## 5. エラーハンドリング
- RailSnapshot が欠損している、もしくは RailNode の復元に失敗したセーブデータをロードしても例外が発生せず、該当列車のみが無視されることを確認。
- 不正な JSON (例: `CurrentSpeed` が `NaN`) を与えた際の例外ログを確認し、ユーザー向けメッセージが適切であることを再確認。

## 6. パフォーマンス・連続保存
- 大規模な編成 (例: 10 両以上) を複数配置した状態で連続セーブ/ロードを実施し、フレーム落ちや保存時間が極端に悪化しないことを計測。
- セーブ直前と直後に `TrainUpdateService` の登録列車数が一致していることをログで確認。

テスト自動化が難しい項目は、Unity エディタ上でのスモークテスト用シナリオを用意して手動確認を行います。
