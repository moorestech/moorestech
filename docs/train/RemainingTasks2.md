# 鉄道システム 残り実装タスク

## 概要
このドキュメントは、サーバー側で実装されている鉄道システムの機能のうち、クライアント側でのUI実装やビジュアル化が不足している項目をリストアップします。

## サーバー側実装済み機能の確認

### TrainUnit（列車本体）
- ✅ 自動運転（`IsAutoRun`, `TurnOnAutoRun()`, `TurnOffAutoRun()`）
- ✅ 手動運転（`masconLevel`による制御）
- ✅ 速度管理（`CurrentSpeed`）
- ✅ 列車分割（`SplitTrain()`）
- ✅ 列車反転（`Reverse()`）

### TrainDiagram（運行ダイアグラム）
- ✅ エントリー追加・削除（`AddEntry()`, `InsertEntry()`）
- ✅ 発車条件設定（`SetDepartureCondition()`）
  - `TrainInventoryFull` - インベントリ満杯
  - `TrainInventoryEmpty` - インベントリ空
  - `WaitForTicks` - 指定tick数待機
- ✅ エントリー移動（`MoveToNextEntry()`）

### TrainCar（車両）
- ✅ インベントリ管理（`GetItem()`, `SetItem()`, `InsertItem()`）
- ✅ 燃料管理（`GetFuelItem()`, `SetFuelItem()`）
- ✅ ドッキング状態管理

### プロトコル
- ✅ 列車配置（`PlaceTrainCarOnRailProtocol`）

---

## クライアント側で不足している実装タスク

### 1. 列車選択・操作UI
**サーバー側実装**: `TrainUnit`の各種メソッド  
**必要な実装**:
- [ ] 列車をクリック/選択するUI
- [ ] 選択中の列車を視覚的に表示（ハイライト、UI表示など）
- [ ] 列車選択解除UI

**備考**: 現在、列車を配置することはできますが、配置後の列車を操作するUIがありません。

---

### 2. 列車手動運転UI（マスコン制御）
**サーバー側実装**: `TrainUnit.masconLevel`（±16777216の範囲）  
**必要な実装**:
- [ ] マスコンレベル調整UI（スライダー、ボタン、キーボード入力など）
- [ ] 前進/後進切り替えUI
- [ ] ニュートラル（停止）操作UI
- [ ] マスコンレベルの視覚的表示（現在値、最大値など）

**サーバー側の現状**: `KeyInput()`メソッドはコメントのみで未実装

**必要なプロトコル**:
- [ ] マスコンレベル変更プロトコル（サーバー側で`masconLevel`を更新するプロトコル）

---

### 3. 列車自動運転ON/OFF UI
**サーバー側実装**: `TrainUnit.TurnOnAutoRun()`, `TurnOffAutoRun()`, `IsAutoRun`  
**必要な実装**:
- [ ] 自動運転ON/OFFボタン
- [ ] 自動運転状態の表示（ON/OFFの視覚的フィードバック）

**必要なプロトコル**:
- [ ] 自動運転ON/OFFプロトコル

---

### 4. ダイアグラム編集UI
**サーバー側実装**: `TrainDiagram.AddEntry()`, `InsertEntry()`, `SetDepartureCondition()`など  
**必要な実装**:
- [ ] ダイアグラムエントリー一覧表示UI
- [ ] エントリー追加UI（駅ノード選択）
- [ ] エントリー削除UI
- [ ] エントリー順序変更UI（ドラッグ&ドロップなど）
- [ ] 発車条件設定UI
  - インベントリ満杯/空のチェックボックス
  - 待機tick数の入力
- [ ] 現在のエントリー（現在位置）の表示

**必要なプロトコル**:
- [ ] ダイアグラムエントリー追加プロトコル
- [ ] ダイアグラムエントリー削除プロトコル
- [ ] ダイアグラムエントリー順序変更プロトコル
- [ ] 発車条件設定プロトコル

---

### 5. 列車インベントリ表示UI
**サーバー側実装**: `TrainCar.GetItem()`, `SetItem()`, `InsertItem()`, `EnumerateInventory()`  
**必要な実装**:
- [ ] 列車のインベントリスロット表示UI
- [ ] 列車インベントリを開くUI（列車選択時に表示）
- [ ] インベントリアイテムのドラッグ&ドロップ
- [ ] 各車両のインベントリ表示（複数車両の場合）

**必要なプロトコル**:
- [ ] 列車インベントリ取得プロトコル（現在のインベントリ状態を取得）
- [ ] 列車インベントリ変更プロトコル（アイテムの追加・削除）

**備考**: ブロックインベントリの実装（`BlockInventoryState`など）を参考に実装可能

---

### 6. 列車燃料表示UI
**サーバー側実装**: `TrainCar.GetFuelItem()`, `SetFuelItem()`, `EnumerateFuelSlots()`  
**必要な実装**:
- [ ] 燃料スロット表示UI
- [ ] 燃料残量の視覚的表示（バー、パーセンテージなど）
- [ ] 燃料の追加UI

**必要なプロトコル**:
- [ ] 列車燃料情報取得プロトコル（既存のインベントリプロトコルで対応可能な可能性あり）

---

### 7. 列車情報表示UI
**サーバー側実装**: `TrainUnit.CurrentSpeed`, `TrainUnit.RailPosition`, `TrainUnit.Cars`など  
**必要な実装**:
- [ ] 列車速度表示（m/s、km/hなど）
- [ ] 列車位置表示（現在のレールノード情報）
- [ ] 列車編成情報表示（車両数、長さなど）
- [ ] ドッキング状態表示（駅に停車中かどうか）

**必要なプロトコル**:
- [ ] 列車状態取得プロトコル（速度、位置、状態など）
  - または、既存のエンティティ同期システムで対応可能か確認

---

### 8. 列車分割UI
**サーバー側実装**: `TrainUnit.SplitTrain(int numberOfCarsToDetach)`  
**必要な実装**:
- [ ] 列車分割UI（分割する車両数を指定）
- [ ] 分割プレビュー表示
- [ ] 分割実行ボタン

**必要なプロトコル**:
- [ ] 列車分割プロトコル

---

### 9. 列車結合UI
**サーバー側実装**: なし（結合機能は未実装）  
**必要な実装**:
- [ ] 列車結合UI（2つの列車を結合）
- [ ] 結合プレビュー表示

**サーバー側で必要な実装**:
- [ ] 列車結合メソッド（`TrainUnit.CombineTrain()`など）

**必要なプロトコル**:
- [ ] 列車結合プロトコル

---

### 10. 列車速度表示（HUD/常時表示）
**サーバー側実装**: `TrainUnit.CurrentSpeed`  
**必要な実装**:
- [ ] 画面に常時表示される速度メーターUI
- [ ] 速度のリアルタイム更新

**必要なプロトコル**:
- [ ] 列車状態取得プロトコル（または既存のエンティティ同期システムで対応）

---

### 11. 列車の方向表示
**サーバー側実装**: `TrainCar.IsFacingForward`, `TrainUnit.Reverse()`  
**必要な実装**:
- [ ] 列車の進行方向を視覚的に表示（矢印など）
- [ ] 列車反転UI（方向を反転させるボタン）

**必要なプロトコル**:
- [ ] 列車反転プロトコル

---

## サーバー側で不足している実装（補足）

### 1. 列車結合機能
- [ ] `TrainUnit.CombineTrain(TrainUnit other)` メソッドの実装

### 2. 列車操作プロトコル
- [ ] マスコンレベル変更プロトコル
- [ ] 自動運転ON/OFFプロトコル
- [ ] ダイアグラム編集プロトコル群
- [ ] 列車インベントリ操作プロトコル
- [ ] 列車分割プロトコル
- [ ] 列車結合プロトコル
- [ ] 列車反転プロトコル
- [ ] 列車状態取得プロトコル（速度、位置、状態など）

---

## 優先度の提案

### 高優先度（基本的な操作）
1. **列車選択・操作UI** - 列車操作の前提
2. **列車手動運転UI** - 基本操作
3. **列車自動運転ON/OFF UI** - 自動運転の基本操作
4. **列車情報表示UI** - 状態確認の基本

### 中優先度（高度な操作）
5. **ダイアグラム編集UI** - 自動運転の設定
6. **列車インベントリ表示UI** - ゲームプレイに重要
7. **列車速度表示（HUD）** - プレイ体験向上

### 低優先度（拡張機能）
8. **列車燃料表示UI** - 燃料システムが重要になった場合
9. **列車分割UI** - 編成管理が重要になった場合
10. **列車結合UI** - 結合機能実装後
11. **列車の方向表示** - UI改善

---

## 参考実装

### 既存のUI実装パターン
- **ブロックインベントリUI**: `BlockInventoryState`, `IBlockInventoryView`
- **プレイヤーインベントリUI**: `PlayerInventoryState`, `PlayerInventoryViewController`
- **ブロック操作UI**: 各種ブロックの`InventoryView`実装

### 既存のプロトコルパターン
- **列車配置プロトコル**: `PlaceTrainCarOnRailProtocol`
- **ブロック操作プロトコル**: 各種`IPacketResponse`実装

---

## 注意事項

1. **エンティティ同期システム**: 列車の位置情報は既に`TrainEntity`としてエンティティ同期システムで送信されています。状態情報（速度、自動運転状態など）も同様に送信されているか確認が必要です。

2. **既存システムとの統合**: ブロックインベントリUIの実装パターンを参考に、列車インベントリUIも同様のパターンで実装できます。

3. **プロトコル設計**: `docs/ProtocolImplementationGuide.md`を参照してプロトコルを実装してください。

4. **テスト**: 各機能の実装後、対応するテストを追加してください。
