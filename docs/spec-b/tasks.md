# Implementation Plan - gear-network-overload-break

- [ ] 1. 過負荷パラメーター定義とマスターデータ準備
- [ ] 1.1 blocksスキーマに過負荷関連パラメーターを追加する (P)
  - GearEnergyTransform系ブロックで利用するRPM閾値、トルク閾値、判定時間間隔、基礎破壊確率、RPM倍率係数、トルク倍率係数をblocksスキーマに追加する。
  - 既存ブロックに影響しないよう、デフォルト値または省略時挙動を設計し、過負荷設定がないブロックは破壊対象外になるようにする。
  - _Requirements: 1.2, 2.1, 2.2, 2.3, 2.8_

- [ ] 1.2 テスト用およびバニラ用マスターデータに過負荷設定を追加する (P)
  - テスト用ブロックおよび代表的なGearEnergyTransformブロックに、過負荷関連パラメーターの具体値を設定する。
  - テストシナリオで扱いやすいよう、破壊確率や閾値を調整し、過負荷状態と非過負荷状態の両方を再現可能にする。
  - _Requirements: 1.2, 2.1, 3.1, 3.2_

- [ ] 2. 過負荷状態管理と破壊確率計算ロジックの実装
- [ ] 2.1 歯車ネットワークごとの過負荷状態フラグとタイマーを管理する (P)
  - 歯車ネットワークIDをキーとした過負荷状態（RPM過負荷、トルク過負荷）、継続時間、判定時間間隔の管理ロジックを導入する。
  - ネットワークが閾値未満に戻った場合にフラグとタイマーをリセットし、不要な破壊判定が行われないようにする。
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 1.6, 3.1, 3.3_

- [ ] 2.2 RPM・トルク超過倍率と最終破壊確率の算出ロジックを実装する (P)
  - RPMおよびトルクの現在値と閾値から超過倍率を計算し、倍率係数を掛け合わせた破壊確率倍率を求めるロジックを実装する。
  - 超過していない要素の倍率を1として扱い、両方超過時は乗算するルールに基づいて最終破壊確率を算出する。
  - _Requirements: 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [ ] 2.3 判定時間間隔ごとの破壊判定スケジューリングを行う
  - 過負荷状態が継続しているネットワークに対して、マスターデータで定義された時間間隔に従い破壊判定を行うタイミングを管理する。
  - 判定時点で過負荷状態が解消されている場合には、破壊判定および乱数評価をスキップするよう制御する。
  - _Requirements: 1.5, 3.1, 3.2, 3.3_

- [ ] 3. GearEnergyTransformネットワークとの統合と破壊対象選択
- [ ] 3.1 GearNetwork更新フローに過負荷監視呼び出しを統合する
  - 既存のギアネットワーク更新処理でRPM・トルク計算とGearNetworkInfo更新が完了したタイミングを利用して、過負荷状態更新ロジックを呼び出す。
  - 既存のネットワーク停止理由やエネルギーバランス計算と干渉しないよう、処理順と条件分岐を整理する。
  - _Requirements: 1.1, 1.5, 3.1, 5.1_

- [ ] 3.2 過負荷破壊判定時に破壊対象となるGearEnergyTransformブロックを選択する
  - 破壊判定が成功した場合に、同一ネットワーク内のGearEnergyTransformブロック集合から少なくとも1つを破壊対象として選択するロジックを実装する。
  - ネットワーク内に破壊対象候補が存在しない場合は、その判定タイミングの破壊処理を安全にスキップする。
  - _Requirements: 3.4, 3.5, 5.2_

- [ ] 3.3 ブロック破壊後にネットワーク構造の変化を次回更新に反映する
  - 破壊されたGearEnergyTransformブロックが属していたネットワークから除去されるよう、GearNetworkDatastoreの再構成ロジックとの整合性を確認する。
  - 破壊後のネットワークに対して、次フレーム以降の過負荷状態・破壊判定が正しく行われることを確認できるようにする。
  - _Requirements: 5.3, 5.4_

- [ ] 4. ブロック破壊サービスと破壊タイプの導入
- [ ] 4.1 ブロック破壊種別を表現する破壊タイプEnumを導入する (P)
  - 「過負荷による破損」と「プレイヤーによる手動撤去」を区別できる破壊タイプEnumを定義し、ブロック破壊関連の処理で利用可能にする。
  - 将来的に破壊理由を拡張できるよう、値の追加に耐えられる構造と命名にする。
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 4.2 ブロック破壊サービスインターフェースと実装を追加する
  - ブロックインスタンスIDと破壊タイプを受け取り、ワールドデータストアを介してブロックを削除するブロック破壊サービスを実装する。
  - 無効な座標や存在しないブロックIDに対しては、ワールドの状態を変更しないようにしつつ、処理が失敗として扱われないようにする。
  - _Requirements: 4.1, 4.4, 4.5_

- [ ] 4.3 プレイヤー操作に基づく手動撤去時に破壊タイプを付与する
  - 既存のブロック撤去フローにおいて、プレイヤー操作による撤去時に「手動撤去」破壊タイプを指定してブロック破壊サービスを呼び出すようにする。
  - 過負荷破壊との区別がログや後続ロジックで利用できるように、破壊タイプが確実に伝搬されることを確認する。
  - _Requirements: 4.1, 4.3, 4.4_

- [ ] 5. GearEnergyTransformブロックへの破壊サービス注入
- [ ] 5.1 GearEnergyTransform系ブロックテンプレートにブロック破壊サービスを渡す
  - GearEnergyTransform系ブロックを生成するテンプレートで、ブロック破壊サービスへの参照を保持・注入する仕組みを追加する。
  - 既存テンプレートの生成経路に影響が及ぶ箇所を洗い出し、一貫した注入パターンに揃える。
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 5.2 過負荷破壊時にGearEnergyTransformブロックからブロック破壊サービスを呼び出す
  - 過負荷判定で破壊対象に選ばれたGearEnergyTransformブロックが、自身のブロックインスタンスIDと「過負荷破壊」タイプを用いてブロック破壊サービスを呼び出すフローを実装する。
  - ネットワーク内の他ブロックへの影響が、次回のネットワーク再構成と過負荷判定に正しく反映されるようにする。
  - _Requirements: 3.4, 4.2, 5.2, 5.3_

- [ ] 6. デバッグ・観測性とテスト
- [ ] 6.1 過負荷状態と破壊イベントのデバッグ出力・記録を追加する (P)
  - 過負荷状態への遷移と解除、判定時間間隔ごとの破壊判定実施有無、算出された最終破壊確率、破壊発生結果を記録・出力する仕組みを追加する。
  - デバッグモードまたは同等の観測設定が無効な場合には、プレイヤー体験に影響する不要なログが出ないよう制御する。
  - _Requirements: 3.2, 3.4, 6.1, 6.2, 6.3_

- [ ] 6.2 過負荷ロジックのユニットテストを作成する (P)
  - 閾値未満／閾値超過の各ケースで過負荷フラグとタイマーが要件通りに変化することを検証するユニットテストを追加する。
  - RPMのみ超過、トルクのみ超過、両方超過のパターンで、超過倍率と最終破壊確率が期待値どおりに計算されることを検証する。
  - _Requirements: 1.3, 1.4, 1.5, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [ ] 6.3 ブロック破壊サービスとネットワーク統合の結合テストを作成する
  - 小規模なギアネットワーク構成で、過負荷状態が一定時間続いたときにGearEnergyTransformブロックが一定確率で破壊されることを確認する結合テストを追加する。
  - 手動撤去時に「手動撤去」タイプが付与され、無効な座標に対する破壊要求ではワールド状態が変化しないことを確認する。
  - _Requirements: 3.4, 3.5, 4.2, 4.3, 4.4, 4.5, 5.2, 5.4_

