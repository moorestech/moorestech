# チャレンジカテゴリシステム実装計画

## 概要
現在の線形チャレンジシステムから、カテゴリベースのツリー構造への移行計画書。

## 現状分析

### 現在の実装
- **構造**: すべてのチャレンジが線形に接続
- **進行**: 前のチャレンジ完了時に次のチャレンジが自動的にアンロック
- **UI**: 横並びのノード表示、マウスホバーで詳細表示

### 変更後の仕様
- **構造**: カテゴリ内にツリー構造のチャレンジを配置
- **進行**: カテゴリのアンロックは特定チャレンジ完了時
- **UI**: 左側にカテゴリリスト、中央にカテゴリ内チャレンジツリー、右側に詳細

## 実装フェーズ

### フェーズ1: サーバー側基盤構築（推定工数: 3-4日）

#### 1.1 データ構造の定義
- [ ] `ChallengeCategoryMasterElement`クラスの作成
  - CategoryGuid, CategoryName, CategoryDescription
  - DisplayOrder（表示順）
  - UnlockCondition（アンロック条件）
- [ ] `ChallengeMasterElement`への`CategoryGuid`フィールド追加
- [ ] `PlayerChallengeInfo`への`UnlockedCategoryGuids`追加
- [ ] `ChallengeJsonObject`への`UnlockedCategoryGuids`追加

#### 1.2 マスターデータ管理
- [ ] `ChallengeCategoryMaster`クラスの実装
  - カテゴリ一覧の管理
  - カテゴリ検索機能
- [ ] 既存の`ChallengeMaster`の拡張
  - カテゴリ別チャレンジ取得機能

#### 1.3 ビジネスロジック
- [ ] `ChallengeDatastore`の拡張
  - カテゴリアンロック処理
  - カテゴリ状態管理
  - セーブ/ロード機能の更新

#### 1.4 アンロック管理
- [ ] `IGameUnlockStateDataController`へのカテゴリ管理追加
  - `UnlockChallengeCategory`メソッド
  - カテゴリアンロック状態の管理

### フェーズ2: API/通信層（推定工数: 2日）

#### 2.1 レスポンス構造の拡張
- [ ] `InitialHandshakeResponse`の`ChallengeResponse`拡張
  - カテゴリ一覧情報
  - カテゴリアンロック状態

#### 2.2 イベント定義
- [ ] `CategoryUnlockedEventMessagePack`の作成
- [ ] `ChallengeEvent`クラスへの`InvokeCategoryUnlocked`追加
- [ ] イベント送信処理の実装

#### 2.3 新規アクションタイプ
- [ ] `unlockChallengeCategory`アクションタイプの追加
- [ ] `UnlockChallengeCategoryChallengeActionParam`の定義

### フェーズ3: クライアント側UI実装（推定工数: 4-5日）

#### 3.1 カテゴリビュー
- [ ] `ChallengeListCategoryView`の実装
  - カテゴリ一覧表示
  - 選択状態管理
  - アンロック状態表示

#### 3.2 ツリービュー
- [ ] `ChallengeListTreeView`の実装
  - カテゴリ内チャレンジのツリー表示
  - ノード配置アルゴリズム
  - 接続線の描画

#### 3.3 既存UIの改修
- [ ] `ChallengeListUI`の改修
  - カテゴリ切り替え機能
  - レイアウト調整
- [ ] `ChallengeListViewManager`の実装
  - ビューの統合管理

#### 3.4 イベント処理
- [ ] カテゴリアンロックイベントの受信処理
- [ ] UI更新処理

### フェーズ4: 演出・最適化（推定工数: 2日）

#### 4.1 アニメーション
- [ ] カテゴリアンロック演出
- [ ] カテゴリ切り替えトランジション
- [ ] チャレンジ完了演出の更新

#### 4.2 パフォーマンス最適化
- [ ] 大量チャレンジ時の描画最適化
- [ ] カテゴリ切り替え時のメモリ管理

## テスト計画

### ユニットテスト
- [ ] `ChallengeDatastore`のカテゴリ機能テスト
- [ ] カテゴリアンロックロジックのテスト
- [ ] セーブ/ロード機能のテスト

### 統合テスト
- [ ] カテゴリアンロックフローの確認
- [ ] 後方互換性テスト（古いセーブデータ）
- [ ] イベント通信テスト

### シナリオテスト
- [ ] 新規プレイヤーのフロー確認
- [ ] 既存プレイヤーの移行確認
- [ ] 複数カテゴリ間の遷移確認

## リスクと対策

### 技術的リスク
1. **後方互換性の確保**
   - 対策: 古いセーブデータ読み込み時の自動変換処理

2. **パフォーマンス問題**
   - 対策: カテゴリ別の遅延読み込み実装

3. **UI複雑化**
   - 対策: 段階的なUI実装とユーザビリティテスト

### 運用リスク
1. **マスターデータ移行**
   - 対策: 移行スクリプトの作成と検証

2. **既存チャレンジのカテゴリ割り当て**
   - 対策: デフォルトカテゴリの設定

## マイルストーン

1. **M1: サーバー側実装完了**（フェーズ1完了時）
   - カテゴリ機能がサーバー側で動作
   - テスト環境での動作確認

2. **M2: API連携完了**（フェーズ2完了時）
   - クライアント・サーバー間の通信確立
   - イベント送受信の確認

3. **M3: 基本UI実装完了**（フェーズ3完了時）
   - カテゴリUIの基本機能動作
   - ユーザー操作可能な状態

4. **M4: リリース準備完了**（フェーズ4完了時）
   - 演出込みの完成版
   - パフォーマンス基準達成

## 実装順序の推奨

1. **最小実装から開始**
   - 単一カテゴリでの動作確認
   - 基本的なアンロック機能

2. **段階的な機能追加**
   - 複数カテゴリ対応
   - 複雑なアンロック条件

3. **UI/UXの洗練**
   - アニメーション追加
   - ユーザビリティ改善

## 総工数見積もり
- 開発: 11-13日
- テスト: 3-4日
- 合計: 14-17日

## 備考
- マスターデータの設計は別途検討が必要
- UI/UXデザインの詳細は別途デザインレビューが必要
- パフォーマンス基準は実装後に測定・調整