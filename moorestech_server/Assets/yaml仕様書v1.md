# マスタ設定ツール用 YAML スキーマ仕様書

本仕様書は、マスタデータをYAMLスキーマで定義し、そのスキーマをもとにモデルおよびUIを構築するための設計指針を示します。  
基本的なルール、プロパティ、および拡張機能や将来的な機能要望などを記述しています。

## 基本フォーマット

スキーマは、`root`要素として`data`配列を持ちます。  
以下は、基本的なスキーマの記述例です。

```yaml
id: idName
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  overrideCodeGeneratePropertyName: OverrideName
  items:
    type: object
    properties:
    - key: masterId
      type: uuid
      autoGenerated: true
```

## 各プロパティの詳細

| プロパティ名 | 説明 | 型 | フォーマット | エディタ影響 | コード生成影響 |
| --- | --- | --- | --- | --- | --- |
| id | スキーマの識別子 | string | 任意 | Yes | Yes |
| key | 要素名 | string | 任意 | Yes | Yes |
| type | 要素の型 | string | `array`, `object`, `string`, `number`, `integer`, `boolean`, `uuid`, `vecotr2`, `vecotr3`, `vecotr4`, `vecotr2Int`, `vecotr3Int`, `vecotr4Int` | Yes | Yes |
| properties | `object`型要素内の子要素配列 | object array | 各要素は`key`必須。`type`または`ref`必須 | Yes | Yes |
| items | `array`型の場合、その要素型を定義 | object | `type`とそれに付随するプロパティ | Yes | Yes |
| autoGenerated | `uuid`専用。エディタ上で自動生成 | boolean |  | Yes |  |
| foreignKey | 外部キー参照 | object | `schemaId`, `keyPath`, `displayElementPath`を持つオブジェクト | Yes | Yes |
| optional | 要素が省略または`null`可 | boolean |  | Yes | Yes |
| default | エディタ上でのデフォルト値 | typeに依存 |  | Yes |  |
| enum | `string`型の値を限定する | string array |  | Yes | Yes |
| ref | 他スキーマをインポート | string | スキーマIDを指定 | Yes | Yes |
| switch | 要素値に応じてスキーマ分岐するためのパス指定 | string | 絶対または相対パス。`string`, `number`, `integer`, `boolean`いずれか | Yes | Yes |
| case | `switch`とセットで使用。条件分岐先スキーマを定義 | object array | `when`, `type`必須 | Yes | Yes |
| when | `case`内で分岐条件値を指定 | switch指定タイプに準拠 |  | Yes | Yes |
| isDefaultOpen | 要素表示時に展開するか | boolean |  | Yes |  |
| fixedParameter | 特定のパス要素を固定値に設定 | object | `path`, `value`を持つオブジェクト | Yes |  |
| overrideCodeGeneratePropertyName | コード生成時のプロパティ/クラス名上書き | string | 任意 |  | Yes |
| defineInterface | インタフェース定義用要素（必ずroot直下） | object array | 配下のobjectは`defineInterface`と`properties`を持つ。`implementationInterface`を持つ場合がある | Yes | Yes |
| interfaceName | `defineInterface`配下で必須 | string | 名前は重複禁止 | Yes | Yes |
| implementationInterface | どのインタフェースを実装するか定義 | string array | `interfaceName`で定義されたもののみ可。循環参照禁止 | Yes | Yes |

## パス指定機能

`switch`や`fixedParameter`など、要素値に応じて分岐や固定値設定を行うため、要素をパスで指定します。  
パスは絶対パス・相対パスをサポートし、そのパス先の要素値を参照します。

## 理想的な実装フロー

1. **スキーマプリプロセス**  
   スキーマファイルをロードする段階で、`schema`フォルダ内のYAMLファイルを読み込み、  
   必要に応じてユーザー定義による拡張を行った最終的なスキーマを得ます。

2. **データのモデル化**  
   プリプロセス済みスキーマを用いて、モデル（データ）構造を定義します。

3. **モデルの表示・編集**  
   モデルをUIに反映し、編集可能なインタフェースを提供します。

## 将来的な機能拡張

### ユーザーによるスキーマ拡張

`schemaExtension`ディレクトリに拡張用のYAMLを配置し、特定のスキーマ要素に対してプロパティを追加できます。  
以下は拡張例です。

```yaml
# 拡張用スキーマ
extensions:
- schemaId: item
  path: properties[0]/items/properties
  schema:
    - key: hp
      type: integer
      default: 100
      optional: true
```

#### 変更前
```yaml
id: items
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  items:
    type: object
    thumbnail: imagePath
    properties:
    - key: itemGuid
      type: uuid
      autoGenerated: true
    - key: name
      type: string
    - key: maxStack
      type: integer
      default: 100
```

#### 変更後（拡張適用）
```yaml
id: items
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  items:
    type: object
    thumbnail: imagePath
    properties:
    - key: itemGuid
      type: uuid
      autoGenerated: true
    - key: name
      type: string
    - key: maxStack
      type: integer
      default: 100
    # 拡張で追加された要素
    - key: hp
      type: integer
      default: 100
      optional: true
```

拡張適用時には、インデックス指定や拡張順序などの課題が生じる可能性があります。  
これはスキーマロード段階で行うため、将来的な課題とします。

### 複数modロードへの対応

複数のmodを同時にロードする場合、複数のデータファイルをマージする必要があります。  
`root`直下の`data`配列をマージする、あるいは`mergeable`プロパティを追加し、  
マージまたはオーバーライド方針を指定できる機構を検討中です。

### パッケージマネージャー

`package.json`的な管理ファイルを用意し、外部からmodをダウンロードし、`node_cache`的な領域に格納する機能を検討しています。

## 拡張機能のサポート

UnityのAddressables（アドレッサブル）など、外部データ参照をサポートする拡張を想定しています。  
これらはバニラ実装ではなく、拡張プラグインや外部ツールとして対応します。

### アドレッサブルとは

アドレッサブル(Addressable)とは、[Unity Addressables](https://docs.unity3d.com/Packages/com.unity.addressables@latest/)機能を指し、アセットを文字列キー（アドレス）で参照・管理できる仕組みです。  
これにより、ビルド済みのアセットバンドルから必要なアセットを動的にロードし、運用後のアセット更新を容易にします。  

### アドレッサブルのドロップダウンサポート

Unity側に専用のサーバーまたはAPIを実装し、現在有効なアドレッサブルアドレス一覧を提供します。  
エディタ（mooreseditor）側はこのリストを取得し、`enum`的な機能としてドロップダウンを構築し、  
ユーザーがアドレスを選択可能にします。

#### サンプルスキーマ例

```yaml
id: addressableExample
type: object
properties:
- key: data
  type: array
  items:
    type: object
    properties:
    - key: assetAddress
      type: unityAddressableAddress
      # アドレス一覧を外部から取得しenum相当としてドロップダウン表示する想定
      # editor拡張のサーバーからアセットアドレス一覧(JSON等)を取得し、enum風にUI表示する
```

## 新しいスキーマトークン・UIサポートの拡張

スキーマに新たなトークンやUIコンポーネントを追加する拡張ポイントも検討中です。

## テンプレート機能

- `object`要素に対して、テンプレートを定義・管理可能にする構想です。
- テンプレートを編集すれば、関連する要素も自動で更新できるようにします。
- テンプレートを適用後、リンクを切り離して個別編集する機能を想定します。

## guidタイトル機能

`guid`だけでは実際のJSONを見たときに何を指すか分かりづらいため、  
`$guidDescription` といった項目を導入し、`guid`に紐づく説明用要素をパス指定で設定する機能を検討しています。  
これにより、人間が見ても分かりやすい表現が可能になります。
