# master yamlスキーマ定義

# マスターのスキーマの仕様書

## 基本的なフォーマット

基本的にroot要素にdataの配列が来るものとする。

```
id: idName
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  overrideCodeGeneratePropertyName: OverrideName
  items:
    type: object
    properties:
    - key: masterId
      type: uuid
      autoGenerated: true

```

## 各プロパティの詳細

### 基本のプロパティ

| プロパティ名 | 説明 | プロパティの型 | フォーマット | エディタに関係する | コード生成に関係する |
| --- | --- | --- | --- | --- | --- |
| id | そのスキーマのid | string | 任意の文字列 | Yes | Yes |
| key | その要素の名前 | string | 任意の文字列 | Yes | Yes |
| type | その要素の型 | string | array, object, string, number, integer, boolean, uuid, vecotr2, vecotr3, vecotr4, vecotr2Int, vecotr3Int, vecotr4Int | Yes | Yes |
| properties | object型の中に入っている要素を列挙する | object array | 各要素はkeyがMUST。typeかrefのどちらかMUST | Yes | Yes |
| items | array型の型を定義する | object | typeとそのタイプの定義に必要な付随要素 | Yes | Yes |
| autoGenerated | uuid専用、エディタ上でuuidを自動生成する | boolean |  | Yes |  |
| foreignKey | 外部キーとなる要素を指定する | object | schemaId, keyPath, displayElementPathの3要素のobject型 パスは絶対パス固定？ | Yes | Yes |
| optional | その要素がnullもしくは要素無しでも良いか | boolean |  | Yes | Yes |
| default | その要素のエディタ上でのデフォルト値を指定する | typeによる |  | Yes |  |
| enum | string要素をいくつかの値に固定する | string array |  | Yes | Yes |
| ref | 他のスキーマをインポートする | string | スキーマIDを指定する | Yes | Yes |
| switch | 要素の値ごとのスキーマを変更するとき、その要素のパスを指定する。caseとセットで使う | string | 絶対パス or 相対パス 指定出来るタイプはstring, number, integer, boolean | Yes | Yes |
| case | switchで指定した要素でどのスキーマに分岐するかを記述する。switchとセットで使う | object array | when, typeの両方がMUST | Yes | Yes |
| when | case内で、そのスキーマとなる値を設定する | switchで指定したタイプによる |  | Yes | Yes |
| isDefaultOpen | その要素を表示時に展開しておくか | boolean |  | Yes |  |
| fixedParameter | パスで指定した要素を特定の値に固定する | object | path 指定する要素のパスvalue 固定する値 | Yes |  |
| overrideCodeGeneratePropertyName | コードジェネレート時のプロパティ、クラス名を上書きする | string | 任意の文字列 |  | Yes |
| defineInterface | interfaceを定義するためのobject
必ずroot直下にある | object array | これ配下のobjectは必ずdefineInterfaceとpropertiesを持つ

implementationInterfaceを持つことがあり、interfaceの実装関係を表す | Yes | Yes |
| interfaceName | defineInterface配下のobjectに必ず記述する | string | 任意の文字列
ただし、他のinterfaceNameと重複禁止 | Yes | Yes |
| implementationInterface | どのinterfaceを実装するかを定義する
これはdefineInterface配下のobjectか、typeがobjectである要素が持つことができる

interface側に定義されているプロパティはpropertiesに記述されていなくても定義されていることになる | string array | interfaceNameに定義されているもののみ
循環参照禁止 | Yes | Yes |

# パス指定機能

switch等でどのパラメーターによって分岐したいかといった要素を指定するため、相対パスor絶対パスで要素を指定し、その要素に応じて条件分岐をすると言った仕組みが必要となる

また、スキーマからパスで指定された要素をある値に固定するといった使い方も考えられる

なので、ある要素からみたときに、そのパスが指し示す要素の値を取得する機能が必要となる

# 理想とする実装

基本的に3つのセクションに分ける

- スキーマプリプロセス
- データのモデル化
- モデルの表示、編集部分

## スキーマプリプロセス

スキーマはファイルをオープした際、schemaフォルダを探し、そのschemaフォルダ内のyamlを開いてモデル、UIを構築する

このとき、以下のようなユーザー定義によるスキーマ拡張をサポートするため、文字列変換によってスキーマを動的に編集する機能をつけたい。

その編集した最終的なスキーマを持って、モデル、UIを構築するようにしたい

## データのモデル化

## 今は使ってないが将来的に必要になる機能

### ユーザーによるスキーマ拡張

`schemaExtension`ディレクトリに`hogehoge.yaml`が入っていて、各`yaml`が拡張情報を持っている感じ。

以下のような拡張スキーマがあったとき：

```yaml
extensions:
- schemaId: item
  path: properties[0]/items/properties
  schema:
    - key: hp
      type: integer
      default: 100
      optional: true

```

こうする：

### 変更前

```yaml
id: items
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  items:
    type: object
    thumbnail: imagePath
    properties:
    - key: itemGuid
      type: uuid
      autoGenerated: true
    - key: name
      type: string
    - key: maxStack
      type: integer
      default: 100

```

### 変更後

```yaml
id: items
type: object
isDefaultOpen: true
properties:
- key: data
  type: array
  items:
    type: object
    thumbnail: imagePath
    properties:
    - key: itemGuid
      type: uuid
      autoGenerated: true
    - key: name
      type: string
    - key: maxStack
      type: integer
      default: 100
    # ---- ここが追加分 ----
    - key: hp
      type: integer
      default: 100
      optional: true

```

...みたいな。

スキーマの拡張の順番等をちゃんと定義しないといけなかったり、例みたいにindexを直で指定すると他のスキーマを拡張したときに意図した拡張ができないと言ったリスクがあるので、色々検討事項が多い。

ただ、これはスキーマをロードしてUIを構築する前段階で行うものなので、今置いておいても大きな問題にはならないはず。

### 複数modロード

複数のmodをロードするということは、当然複数の実データファイルを読み込む必要がある。

どうすればいいか思いついていないが、`root`直下の`data`配列だけマージする、もしくは`mergeable`といったプロパティを容易して、複数ロードしたときにマージするかオーバーライドするかと言った情報を付与できるようにするのが良いのかもしれない。

### パッケージマネージャー

`package.json`みたいなものを定義して、パッケージマネージャーからmodをDLして`node_cache`的なところに全部ぶち込むみたいな処理をする必要がある。

# 拡張機能のサポート

Unityのアドレッサブルといった、外部の要素によって指定するものが変わる情報を指定できるようにしたい

ただし、このへんはバニラ実装の枠ではなく、拡張機能としてさぽーどできるのが理想ではある

## アドレッサブルの選択

### アドレッサブルとは

TODO 詳しく説明
unityのアセットを文字列で指定できるやつ

### アドレッサブルのドロップダウンサポート

Unity側にもmooreseditorに対応したサーバーを入れ、現在のアドレッサブルのアドレスのリストを提供し、そのデータを下にドロップダウンを構築、バリデートする

TODO これのサンプルスキーマ

## 現状での必要な拡張ポイント

- 新しいスキーマトークンのサポート
- 新しいUIのサポート

# テンプレート機能

- あるobject要素に対して、テンプレートを作成、管理することができる
- テンプレートはテンプレート側を編集したら勝手に他の値も変わる
- テンプレートの値を適用し、テンプレートとのリンクを解除して個別で設定できるようにする

# guidタイトル機能

出力された実際のjsonを見ると、guidだけだと何を登録しているのかがわかりづらいので、人間が見てもわかるようにしたい

guidの下に $guidDescripton と言った項目を用意し、guidにどの要素がguidDesciprtionになるかをパスで指定する