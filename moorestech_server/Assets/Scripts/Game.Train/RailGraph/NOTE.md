# RailGraphついて  

## 用語定義  
- 頂点,ノード,レールノード,RailNode：レールのつなぎ目。グラフのノードに対応、エッジであるレールに"接合"する  
- 辺,エッジ,レールエッジ,RailEdge:レール本体に相当。このレールは有向グラフで考えるので一方通行である。表示と計算では違う。計算のほうでは有向グラフとして考えたほうがいろいろ見通しが良い(多分)  
- レールグラフ,RailGraph:レールノードとレールエッジをすべて含む。最短経路計算を行う専用のクラスを用意したい  
- グラフでいう頂点がレールノード、辺がレールエッジである  

## 概念説明  
- 合流分岐でレールの角度により曲がれない、つまり頂点でつながっていても辺がつながってないということが起こる  
- このため有向グラフで考えることとした  

### 例えばY字の構造を考えると  
- Y字の、上2つの頂点をA,B、真ん中の合流をC、下を頂点Dとする  
- A→C、B→CはありえてそのままC→Dとつながるが、A→C→Bの経路は存在できない(列車がCで反転すればできるが)  
- しかしA→CもC→Bも経路としては存在するのでA→C→Bをどう弾くかとう問題になる  
- そこで頂点を二重にする  
- 頂点CをC1,C2という頂点に分離し、C1を下方向専用の、C2を上方向専用のものと考える  
- 下方向にはA→C1、B→C1,C1→Dという経路とし、上方向はD→C2、C2→B、C2→Aという経路にする  
- これによってA→Bのルートが作れないことが明快になる(C1→Bは存在できないため)  

### すべてのレールノードの場所は頂点が二重になっている  
- 上記理論を適応するにはすべての合流、分岐の頂点を二重にすればよい  
- 1つのレールブロックを設置したとき、下方向、上方向の2つのノードができることになる  
- なおコード内では表、裏と書いてあるかもしれない  


## 列車編成について  

### 列車編成がもつ情報について  
- 列車の先頭と最後尾の位置のみでは全ての車両の位置が一意に決まらない  
- 例：20量分の長さのレールのループがあり、100量編成の車列が5重ループを形成しているとき  
- したがって列車の最後尾の後輪が、先頭の前輪までにどのルートをたどるかをすべてわかってないといけない  
- これをNodePathクラスでどうにかする  
    - この情報を1編成インスタンスにもたせる  
    - 持つべき情報は通るルート上のノード、正確には最後尾の後輪が存在するレールの始点と終点を含むノード、通過ノード、先頭の前輪が存在するレールの始点と終点を含むノード、このリスト  
    - 先頭の前輪が存在するレールの終点まで、前輪があとどのくらい離れているか  

## NodePathについて  
- RailNodeのリストを持ち、現在地を示すためのクラス  
- リストのindexが小さいほうに向かおうとしている  
### 持つ情報  
- RailNodeのリスト  
- RailNodeのリストのうち、現在地がどことどこのNodeに挟まれているか。これは向かう先のRailNodeのindexだけを記憶すればいい  
- 現在地は、その向かう先のRailNodeのindexまで整数値でどのくらいの距離があるか  
### メゾット  
- 整数で入力された距離だけ進む、絶対進めなければfalseを返す、進めればtrueを返す。リストに進行方向のNodeがなかったら自動でランダムに選択しリスト更新  
- 反転する(保持しているRailNodeのリストの反転と、Node自体の裏表反転)  
- 進行方向の進む予定のRailNodeのリストを新しく更新する  
- 現在進行している先のRailNodeのみを返す  
- 現在進行している1つ前のRailNodeのみを返す  

## RailGraphクラス,RailNode  
- シングルトン  
- 最短経路探索はダイクストラ法 or Astar  
- 距離は今のところintで  
- NodePathの入力にも対応  
- RailNodeはAstarのため座標も記憶したいが同じじょうほうになるのでレールブロックの参照をだけ保持  

## 駅  
- RailNode4つで再現  
- 1,順方向の入口  
- 2,逆方向の出口(1の裏表に対応)  
- 3,順方向の出口  
- 4,逆方向の入口(3の裏表に対応)  
- 編成のNodePathから1に到着していると判断されたら駅についたことになる  

## エッジの計算  
- ベジエ曲線?  
- NodePathを入力として現在地を返す静的メソッド1個作る  


## 考慮していること  
- 運行中に貨車が外れたら編成が分割する(factorioと同じ)  
- 編成が反転できる  
- 手動運転できる  
- 見た目上のループは存在できる(実際は始点と終点のノードはわかれているのでグラフ理論のループにはなってない)  

## 考慮すべきこと、できないことなど  
- 多重辺は存在できない。頂点A→Bをつなぐ辺は必ず1本まで。つまり頂点A→Bの辺が2本以上存在してはいけない(Satisfactoryと同じ)  
- レール上に列車が乗っている場合、レール削除したらどうなる→レール削除できないようにするか  
- ノード削除時、全探索O(N)するか、接続ノードだけみてO(1)削除するか  
- 駅は一方通行としてもいいかも(有向グラフの使い所)  
- 列車の衝突は考慮しない  

